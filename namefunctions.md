# Функции расширения Chrome для закладок

## Обновления и исправления

- **Исправления стилей для диалога добавления элементов** - Добавлен новый файл `src/styles/fixes.css` для исправления визуальных проблем в диалоге добавления папок и закладок.

- **Улучшен механизм локализации** - В методе `t` класса `I18n` добавлена обработка случаев отсутствия перевода, теперь метод возвращает форматированную последнюю часть ключа.

- **Добавлены новые ключи локализации** - В файлы локализации `src/locales/ru.js` и `src/locales/en.js` добавлены ключи для кнопок добавления папок и закладок.

- **Исправлена функция диалога редактирования папок** [504-657] в `popup.js` - Восстановлена возможность загрузки пользовательских иконок для папок.

- **Исправлена функция отображения папок с учетом темы** в `src/components/MainInterface.js` и `src/components/NestedMenu.js` - Исправлено отображение иконок папок для темной темы.

- **Исправлена конфигурация в constants.js** - Добавлен идентификатор для кнопки корзины и исправлена структура кнопок добавления.

- **Добавлена функция `optimizeImage(file)`** [658-716] в `popup.js` - Оптимизирует загруженные изображения для использования в качестве иконок папок.

- **chrome.storage API** - Исправлено единообразное использование `chrome.storage.local` вместо `chrome.storage.sync` во всех файлах проекта для последовательного хранения настроек темы, языка и состояния навигации. Обновленные файлы: `src/utils/i18n.js`, `src/utils/theme.js`, `src/trash.js`, `src/settings.js`, `src/components/MainInterface.js`, `src/components/NestedMenu.js`.

- **Добавлена функция `showAddDialog(parentId)`** [717-763] в `popup.js` - Показывает диалог выбора типа элемента для добавления (закладка или папка).

- **Добавлена функция `showCreateFolderDialog(parentId)`** [764-801] в `popup.js` - Показывает диалог создания новой папки.

- **Добавлена функция `showCreateBookmarkDialog(parentId)`** [802-840] в `popup.js` - Показывает диалог создания новой закладки.

## src/utils/bookmarks.js

- **getAllBookmarks(forceUpdate)** [8-44] - Получает все закладки из хранилища с опциональным принудительным обновлением, реализует кеширование данных для оптимизации (30 секунд).
- **createBookmark(parentId, title, url)** [47-49] - Создает новую закладку в указанной родительской папке.
- **createFolder(parentId, title)** [52-54] - Создает новую папку в указанной родительской папке.
- **getBookmarksInFolder(folderId, forceUpdate)** [57-121] - Получает закладки из конкретной папки с опциональным принудительным обновлением, использует кеширование.
  - **findFolder(items)** [80-90] - Вспомогательная внутренняя функция для поиска папки в дереве закладок.
- **importFromBrowser()** [124-147] - Импортирует закладки из браузера Chrome и сохраняет их в локальное хранилище расширения.
- **processBookmarkTree(bookmarks)** [150-177] - Рекурсивно обрабатывает дерево закладок из браузера при импорте (вспомогательная функция для importFromBrowser).
- **generateUniqueId()** [179-181] - Генерирует уникальный ID для новых закладок и папок.
- **exportBookmarksToHTML()** [184-191] - Экспортирует закладки в формат HTML (стандартный формат экспорта закладок браузера).
- **generateBookmarksHTML(bookmarks, level)** [194-217] - Генерирует HTML разметку для экспорта закладок (вспомогательная функция для exportBookmarksToHTML).
- **updateBookmark(id, data)** [225-262] - Обновляет существующую закладку или папку по ID, устанавливая новые данные (название, URL).
  - **updateInTree(items)** [280-292] - Вспомогательная внутренняя функция для поиска и обновления элемента в дереве закладок.
- **deleteBookmark(bookmarkId)** [267-296] - Удаляет закладку или папку по ID.
  - **deleteFromTree(items)** [317-336] - Вспомогательная внутренняя функция для поиска и удаления элемента из дерева закладок.
- **copyBookmark(id, parentId)** [301-351] - Копирует папку или закладку в указанную родительскую папку.
  - **findInTree(items)** [359-371] - Вспомогательная внутренняя функция для поиска элемента в дереве закладок.
  - **findParentFolder(items, targetId)** [372-384] - Вспомогательная внутренняя функция для поиска родительской папки.
  - **generateNewId()** [385-387] - Вспомогательная внутренняя функция для генерации нового ID.
  - **deepClone(item)** [389-396] - Вспомогательная внутренняя функция для глубокого клонирования элемента с новыми ID.
- **updateFolder(id, data)** [356-379] - Обновляет существующую папку (название, иконка).
  - **updateInTree(items)** [433-446] - Вспомогательная внутренняя функция для поиска и обновления папки в дереве закладок.
- **moveBookmark(itemId, targetFolderId)** [386-460] - Перемещает закладку или папку в другую папку.
  - **findAndExtractItem(items, parentPath)** [491-512] - Вспомогательная внутренняя функция для поиска и извлечения элемента из дерева.
  - **addToTargetFolder(items)** [522-534] - Вспомогательная внутренняя функция для добавления элемента в целевую папку.
- **isChildFolder(bookmarks, sourceId, targetId)** [467-490] - Проверяет, является ли целевая папка подпапкой исходной (предотвращает циклические ссылки при перемещении).
  - **checkInFolder(items)** [572-578] - Вспомогательная внутренняя функция для поиска исходной папки.
  - **isDescendant(folder)** [580-589] - Вспомогательная внутренняя функция для проверки вложенности папок.
- **findFolderById(bookmarks, folderId)** [497-508] - Находит папку по ID в дереве закладок.
- **reorderBookmarks(sourceId, targetId, parentId)** [516-637] - Меняет порядок закладок в указанной папке.
  - **findFolder(items)** [650-661] - Вспомогательная внутренняя функция для поиска папки по ID.
  - **verifyInFolder(items)** [760-785] - Вспомогательная внутренняя функция для проверки успешности операции.
- **isChildOf(parentId, childId)** [644-704] - Проверяет, является ли папка потомком (непосредственным или вложенным) другой папки.
  - **checkIsChild(items, targetId)** [656-668] - Вспомогательная внутренняя функция для проверки вхождения элемента в папку.
  - **findFolder(items, id)** [671-686] - Вспомогательная внутренняя функция для поиска папки по ID.

## src/utils/errorHandler.js

- **ErrorType** [2-12] - Объект с константами для типов ошибок (CREATE, UPDATE, DELETE, COPY, LOAD, NAVIGATION, MOVE, RESTORE, REORDER).
- **errorMessages** [15-49] - Объект с сообщениями об ошибках для различных типов и подтипов ошибок.
- **ErrorHandler.handle(error, type, subtype)** [56-67] - Статический метод для обработки ошибок с выводом сообщения пользователю и логированием в консоль.
- **ErrorHandler.wrapAsync(promise, type, subtype)** [69-75] - Статический метод-обертка для асинхронных функций, автоматически обрабатывающий ошибки с помощью ErrorHandler.handle.

## src/utils/i18n.js

- **I18n** [4-56] - Класс для интернационализации приложения.
  - **constructor()** [5-11] - Инициализирует объект с русской локалью по умолчанию, загружает переводы и настраивает систему слушателей.
  - **initLocale()** [13-19] - Асинхронно инициализирует локаль из хранилища Chrome.
  - **setLocale(locale)** [21-25] - Устанавливает новую локаль и сохраняет её в хранилище Chrome.
  - **t(key, params)** [27-45] - Возвращает перевод по указанному ключу с опциональной подстановкой параметров.
  - **addListener(callback)** [47-49] - Добавляет слушателя изменений локали.
  - **removeListener(callback)** [51-53] - Удаляет слушателя изменений локали.
  - **\_notifyListeners()** [55-59] - Уведомляет всех слушателей об изменении локали.
- **i18n** [64] - Экспортированный экземпляр класса I18n для использования во всем приложении.

## src/utils/navigation.js

- **Navigation** [1-58] - Класс для управления навигацией по папкам закладок.
  - **constructor()** [2-5] - Инициализирует пустой стек навигации и набор слушателей.
  - **currentFolder** [getter, 7-9] - Возвращает текущую папку (последнюю в стеке).
  - **isRoot** [getter, 11-13] - Проверяет, находимся ли в корневой папке.
  - **getStack()** [15-17] - Возвращает копию текущего стека навигации.
  - **setStack(newStack)** [19-22] - Устанавливает новый стек навигации.
  - **push(folder)** [24-27] - Добавляет папку в стек навигации и уведомляет слушателей.
  - **pop()** [29-35] - Возвращается на уровень вверх (удаляет последнюю папку из стека).
  - **clear()** [37-40] - Очищает стек навигации (возвращает в корень).
  - **getCurrentParentId()** [46-48] - Возвращает ID текущей родительской папки.
  - **addListener(callback)** [50-52] - Добавляет слушателя изменений навигации.
  - **removeListener(callback)** [54-56] - Удаляет слушателя изменений навигации.
  - **\_notifyListeners()** [58-62] - Уведомляет всех слушателей об изменении навигации.

## src/utils/theme.js

- **initTheme()** [1-28] - Инициализирует систему тем (темная/светлая) и устанавливает обработчики переключения.
- **setTheme(isDark)** [30-39] - Устанавливает темную или светлую тему и сохраняет выбор в хранилище Chrome.

## src/utils/window.js

- **DOMContentLoaded event listener** [2-10] - Устанавливает фиксированные размеры окна расширения при загрузке документа.

## src/utils/storage.js

- **Storage** [2-47] - Класс для работы с локальным хранилищем Chrome.
  - **constructor()** [3-6] - Инициализирует хранилище с ключом "gh_bookmarks".
  - **initializeStorage()** [8-30] - Проверяет наличие закладок в хранилище и создает начальную структуру с базовыми папками, если необходимо.
  - **get(key)** [32-38] - Получает данные из хранилища Chrome по ключу.
  - **set(key, value)** [40-46] - Сохраняет данные в хранилище Chrome по ключу.
- **storage** [50] - Экспортированный экземпляр класса Storage для использования во всем приложении.
- **getStoredBookmarks()** [53-56] - Получает все закладки из хранилища.
- **createStoredBookmark(parentId, title, url)** [59-108] - Создает новую закладку или папку в хранилище.
  - **addToFolder(items)** [94-106] - Вспомогательная внутренняя функция для добавления закладки в папку.
- **getBookmarksFromFolder(folderId)** [111-133] - Получает закладки из указанной папки.
  - **findFolder(items)** [118-130] - Вспомогательная внутренняя функция для поиска папки по ID.
- **saveBookmarks(bookmarks)** [136-138] - Сохраняет все закладки в хранилище.
- **getFavicon(url)** [141-172] - Получает иконку для URL (favicon) сначала через Google Favicon Service, затем напрямую с сайта.
- **generateUniqueId()** [175-177] - Генерирует уникальный ID для новых закладок и папок.
- **findFolderById(bookmarks, folderId)** [179-189] - Находит папку в дереве закладок по ID.
- **addBookmarkToFolder(bookmarks, parentId, newBookmark)** [191-204] - Добавляет закладку в указанную папку с сохранением структуры дерева.

## src/background.js

- **chrome.runtime.onInstalled** [2-34] - Обработчик события установки расширения. Инициализирует настройки по умолчанию и базовую структуру папок закладок.
- **chrome.runtime.onMessage** [37-48] - Обработчик сообщений от popup. Обрабатывает запросы на экспорт закладок.

## src/settings.js

- **DOMContentLoaded** [6-58] - Инициализирует UI страницы настроек, устанавливает обработчики событий.
- **updateLanguageToggle()** [61-64] - Обновляет состояние переключателя языка в соответствии с текущим языком.
- **translatePage()** [67-72] - Переводит все элементы страницы с атрибутом data-translate на текущий язык.
- **handleThemeToggle(e)** [75-81] - Обработчик переключения темы оформления.
- **importBookmarksFromBrowser()** [84-91] - Импортирует закладки из браузера Chrome.
- **exportBookmarksToFile()** [94-117] - Экспортирует закладки в HTML-файл.
- **generateBookmarksHTML(bookmarks)** [120-152] - Генерирует HTML-код для экспорта закладок.
  - **generateBookmarkItem(item, indent)** [136-147] - Вспомогательная внутренняя функция для генерации HTML разметки отдельной закладки или папки.
- **importBookmarksFromFile(file)** [155-163] - Импортирует закладки из HTML-файла.
- **readFileContent(file)** [166-172] - Читает содержимое файла.
- **parseBookmarksHTML(html)** [175-228] - Парсит HTML-файл с закладками.
  - **processNode(node)** [178-216] - Вспомогательная внутренняя функция для обработки узлов HTML и извлечения закладок.

## src/trash.js

- **DOMContentLoaded** [8-21] - Инициализирует страницу корзины, устанавливает локализацию.
- **translatePage()** [23-29] - Переводит все элементы страницы на текущий язык.
- **initializeUI()** [31-83] - Инициализирует интерфейс страницы корзины, устанавливает обработчики событий.
- **handleThemeToggle(e)** [85-91] - Обработчик переключения темы оформления.
- **renderTrashItems()** [93-158] - Отрисовывает элементы корзины на странице.
- **restoreContents(parentId, contents)** [160-177] - Рекурсивно восстанавливает содержимое удаленной папки.
- **handleRestore(item)** [179-242] - Обрабатывает восстановление элемента из корзины.

## src/services/TrashStorage.js

- **TrashStorage** [1-134] - Класс для работы с хранилищем удаленных элементов (корзина).
  - **constructor()** [2-6] - Инициализирует хранилище с именем базы данных и хранилища.
  - **init()** [8-30] - Инициализирует IndexedDB для хранения удаленных элементов.
  - **moveToTrash(item, navigationStack)** [32-53] - Перемещает элемент в корзину с сохранением пути навигации.
  - **restoreItem(id)** [55-76] - Восстанавливает элемент из корзины.
  - **getTrashItems()** [78-93] - Получает все элементы из корзины.
  - **clearTrash()** [95-110] - Очищает корзину.
  - **hasItems()** [112-120] - Проверяет, есть ли элементы в корзине.
- **trashStorage** [138] - Экспортированный экземпляр класса TrashStorage для использования во всем приложении.

## src/services/IconStorage.js

- **IconStorage** [1-110] - Класс для работы с хранилищем иконок папок.
  - **constructor()** [2-7] - Инициализирует свойства для работы с IndexedDB.
  - **init()** [9-28] - Инициализирует базу данных IndexedDB для хранения иконок.
  - **saveIcon(folderId, iconBlob)** [30-47] - Сохраняет иконку папки в хранилище.
  - **getIcon(folderId)** [49-64] - Получает иконку папки из хранилища.
  - **deleteIcon(folderId)** [66-81] - Удаляет иконку папки из хранилища.
  - **migrateFromStorage()** [83-107] - Мигрирует иконки из Chrome Storage в IndexedDB.
- **iconStorage** [110] - Экспортированный экземпляр класса IconStorage для использования во всем приложении.

## src/locales/ru.js

- **default export** [1-79] - Объект с переводами на русский язык, структурированный по разделам интерфейса (модальные окна, кнопки, метки, подтверждения, валидация, сообщения, настройки, корзина, ошибки, drag-and-drop).

## src/locales/en.js

- **default export** [1-79] - Объект с переводами на английский язык, структурированный по тем же разделам, что и в ru.js.

## src/config/constants.js

- **ICONS** [2-23] - Объект с путями к иконкам для различных элементов интерфейса с учетом темы (светлая/темная).
- **UI_TEXTS** [26-56] - Объект с текстами интерфейса, сгруппированными по назначению (модальные окна, кнопки, метки, подтверждения).
- **CONTEXT_MENU_CONFIG** [59-88] - Конфигурация контекстного меню для папок и закладок.
- **ADD_BUTTONS_CONFIG** [91-106] - Конфигурация кнопок добавления для разных типов элементов.
- **STORAGE_KEYS** [109-112] - Ключи для хранилища Chrome.
- **DOM_IDS** [115-122] - ID HTML-элементов для доступа в JavaScript.
- **CSS_CLASSES** [125-131] - CSS-классы, используемые в приложении.

## src/components/NestedMenu.js

- **NestedMenu** [4-100] - Класс для отображения вложенного меню закладок.
  - **constructor(container, bookmarks)** [5-8] - Инициализирует компонент с контейнером и данными закладок.
  - **getCurrentTheme()** [11-17] - Асинхронно получает текущую тему из хранилища Chrome.
  - **getDefaultFolderIcon()** [20-23] - Возвращает путь к иконке папки по умолчанию в зависимости от темы.
  - **getFolderIcon(folderId)** [25-35] - Получает иконку папки из хранилища или возвращает иконку по умолчанию.
  - **render()** [37-96] - Отрисовывает меню с закладками и папками в контейнере.
  - **destroy()** [98-100] - Очищает контейнер и удаляет CSS-класс.

## src/components/Modal.js

- **Modal** [3-167] - Класс для работы с модальными окнами.
  - **constructor()** [4-8] - Инициализирует объект модального окна.
  - **create(title, type, initialData, customContent)** [10-92] - Создает модальное окно с заданными параметрами.
  - **createInputGroup(id, label, value)** [94-110] - Создает группу ввода с меткой и полем ввода.
  - **handleSave(type)** [112-125] - Обрабатывает сохранение данных из модального окна.
  - **close()** [127-133] - Закрывает модальное окно и удаляет его из DOM.
  - **show(title, type, initialData, onSave, onClose, customContent)** [135-139] - Показывает модальное окно с заданными параметрами и обработчиками.

## src/components/MainInterface.js

- **MainInterface** [4-121] - Класс для отображения основного интерфейса закладок.
  - **constructor(container, bookmarks)** [5-8] - Инициализирует компонент с контейнером и данными закладок.
  - **getCurrentTheme()** [11-17] - Асинхронно получает текущую тему из хранилища Chrome.
  - **getCustomFolderIcon(folderId)** [20-30] - Получает пользовательскую иконку папки из хранилища.
  - **getDefaultFolderIcon()** [33-36] - Возвращает путь к иконке папки по умолчанию в зависимости от темы.
  - **getFolderIcon(folderId)** [38-48] - Получает иконку папки из хранилища или возвращает иконку по умолчанию.
  - **render()** [50-118] - Отрисовывает закладки и папки в контейнере, обрабатывает пустой список.

## src/components/ContextMenu.js

- **ContextMenu** [3-99] - Класс для работы с контекстным меню.
  - **constructor()** [4-29] - Инициализирует объект контекстного меню и устанавливает обработчики его закрытия.
  - **close()** [31-38] - Закрывает контекстное меню.
  - **show(x, y, items, target, onAction)** [40-97] - Показывает контекстное меню в указанных координатах с заданными элементами.

## src/libs/Sortable.min.js

Подключена внешняя библиотека Sortable.js (версия 1.15.0) для реализации функциональности drag-and-drop. Библиотека обеспечивает возможность перетаскивания элементов, сортировку списков и другие операции с интерактивными элементами интерфейса.

## src/popup.js

- **DOMContentLoaded** [56-105] - Обработчик события загрузки документа. Инициализирует хранилище иконок, тему, обрабатывает параметр пути и настраивает локализацию.
- **translatePage()** [114-120] - Переводит элементы интерфейса с атрибутом data-translate на текущий язык.
- **getFolderContentsRecursively(folderId)** [123-132] - Рекурсивно получает содержимое папки, включая все вложенные папки.
- **handleFolderClick(bookmarkElement)** [134-188] - Обрабатывает клик по папке, загружает её содержимое и обновляет UI.
- **handleBackButtonClick()** [190-279] - Обрабатывает нажатие кнопки "Назад", возвращаясь на предыдущий уровень навигации.
- **handleContextMenu(e)** [281-403] - Показывает контекстное меню при правом клике на закладке или папке с опциями редактирования, удаления и копирования.
- **handleThemeToggle(e)** [404-420] - Переключает между светлой и темной темой оформления.
- **getCurrentThemeState()** [422-433] - Возвращает текущую тему ("dark" или "light").
- **restoreThemeState(theme)** [435-441] - Восстанавливает указанную тему оформления.
- **refreshCurrentView(forceUpdateCache)** [445-532] - Обновляет текущее представление закладок с учетом кэширования.
- **continueRefreshCurrentView(mainContent, currentFolderTitle, forceUpdateCache)** [534-664] - Продолжает обновление представления, загружая закладки и обновляя DOM.
- **showLoadingIndicator()** [666-679] - Показывает индикатор загрузки.
- **hideLoadingIndicator()** [681-689] - Скрывает индикатор загрузки.
- **showErrorMessage(message)** [691-693] - Отображает сообщение об ошибке.
- **initializeUI()** [695-761] - Инициализирует основной интерфейс, устанавливает обработчики событий и загружает корневые закладки.
- **showAddDialog(parentId)** [764-817] - Показывает диалог выбора типа элемента для добавления (закладка или папка).
- **showCreateFolderDialog(parentId)** [819-834] - Показывает диалог создания новой папки.
- **showCreateBookmarkDialog(parentId)** [836-852] - Показывает диалог создания новой закладки.
- **optimizeImage(file)** [854-896] - Оптимизирует загруженное изображение, уменьшая его размер.
- **handleIconUpload(file, folderId)** [898-919] - Обрабатывает загрузку пользовательской иконки для папки.
- **setupFileInput(customContent, folder)** [921-970] - Настраивает ввод файла для загрузки иконки папки.
- **showFolderEditDialog(folder)** [972-996] - Показывает диалог редактирования папки.
- **createFolderEditContent(folder, savedIconUrl)** [999-1037] - Создает содержимое диалога редактирования папки.
- **handleFolderEdit(folder, customContent, modal)** [1039-1091] - Обрабатывает сохранение изменений при редактировании папки.
- **initDragAndDrop()** [1093-1388] - Инициализирует функциональность drag-and-drop с использованием библиотеки Sortable.js.
- **processDragEnd(dragInfo)** [1390-1429] - Обрабатывает завершение операции перетаскивания.
- **refreshCurrentFolder()** [1431-1488] - Обновляет содержимое текущей папки.
- **continueRefreshCurrentFolder()** [1490-1504] - Продолжает обновление текущей папки.
- **moveItemToFolder(itemId, folderId)** [1506-1581] - Перемещает элемент в другую папку.
- **showDragIndicator(show)** [1583-1602] - Показывает или скрывает индикатор перетаскивания.
- **handleItemReordered(item, oldIndex, newIndex)** [1604-1656] - Обрабатывает изменение порядка элементов внутри контейнера.
- **handleItemMoved(item, fromContainer, toContainer, newIndex)** [1658-1691] - Обрабатывает перемещение элемента между папками.
- **showNotification(message, duration)** [1693-1722] - Показывает временное уведомление.
- **getTranslation(key)** [1724-1726] - Получает текст перевода по ключу.
- **createBookmarkElement(item, cachedIcons)** [1734-1821] - Создает DOM-элемент закладки или папки для отображения.
- **handleButtonClick(e)** [1823-1904] - Обрабатывает клики по кнопкам в элементе закладки.
- **setupBackButtonDropTarget()** [1906-2025] - Настраивает кнопку "Назад" как цель для перетаскивания.
- **handleDrop(evt)** [2027-2130] - Обрабатывает событие drop для перетаскиваемых элементов.
- **hideSettingsPage()** [2132-2168] - Скрывает страницу настроек и возвращает к основному интерфейсу.
- **hideTrashPage()** [2170-2203] - Скрывает страницу корзины и возвращает к основному интерфейсу.
- **clearHoverTimers()** [2205-2217] - Очищает все таймеры наведения.
- **updateFolderTitle(title)** [2219-2226] - Обновляет заголовок текущей папки.
- **toggleBackButton(show)** [2228-2233] - Показывает или скрывает кнопку "Назад".

## HTML файлы интерфейса

- **src/popup.html** - Основной интерфейс расширения с кнопками навигации, добавления закладок, перехода в корзину и настройки; содержит основной контейнер для отображения закладок.
- **src/settings.html** - Интерфейс страницы настроек с функциями импорта/экспорта закладок, переключением языка и информацией об авторе.
- **src/trash.html** - Интерфейс корзины с удаленными элементами и кнопкой для очистки корзины.

## CSS стили интерфейса

- **src/styles/dark-theme.css** - Определяет цветовую схему для темной темы, включая цвета фона, текста, границ и акцентов; переопределяет базовые элементы интерфейса для темного режима.
- **src/styles/light-theme.css** - Определяет цветовую схему для светлой темы с аналогичной структурой переменных; устанавливает светлые цвета для тех же элементов интерфейса.
- **src/styles/popup.css** - Содержит стили для функционала drag-and-drop, включая стили для перетаскиваемых элементов, индикаторов и подсветки зон для перетаскивания.
- **src/styles/settings.css** - Стили для страницы настроек, включая контейнеры, кнопки, переключатели языка, секции настроек и авторскую информацию.

### src/styles/main.css

1. **Базовые переменные и настройки** [1-70] - Определяет основные CSS-переменные (размеры, цвета, радиусы, анимации), устанавливает базовые стили для HTML и body, задает размеры окна расширения.

2. **Базовая структура интерфейса** [71-150] - Стили для основных контейнеров приложения, шапки (.header), позиционирование кнопок и элементов управления в шапке.

3. **Компоненты закладок и папок** [151-250] - Стили для элементов закладок (.bookmark-item), иконок (.bookmark-icon), заголовков (.bookmark-title), сетки элементов и пустых состояний.

4. **Переключатели и элементы управления** [251-350] - Стили для переключателя темы (.theme-switch), кнопок настроек, различия в отображении иконок в зависимости от текущей темы.

5. **Модальные окна и контекстное меню** [351-550] - Стили для модальных окон (.modal), контекстного меню (.context-menu), форм ввода и кнопок, всплывающих диалогов.

6. **Специфичные стили для тем** [551-750] - Переопределение стилей и цветов для светлой и темной темы, настройка скроллбара, кнопок и интерактивных элементов в зависимости от темы.

7. **Drag-and-Drop функциональность** [751-1388] - Стили для перетаскивания элементов, индикаторы для визуальной обратной связи, анимации для элементов во время перетаскивания, стили для библиотеки Sortable.js, индикаторы загрузки и уведомления.

## src/utils/logging.js

- **DEBUG_MODE** [7] - Флаг для включения/отключения логирования (true - включено, false - выключено).
- **log(message, data)** [15-23] - Выводит информационное сообщение в консоль, если включен режим отладки.
- **logError(message, error)** [31-39] - Выводит сообщение об ошибке в консоль независимо от режима отладки.
- **logWarn(message, data)** [47-55] - Выводит предупреждающее сообщение в консоль, если включен режим отладки.

## src/modules/NavigationModule.js

- **NavigationModule** [13-252] - Класс для управления навигацией по папкам закладок.
  - **constructor(container, updateUI)** [19-28] - Инициализирует модуль навигации с контейнером и функцией обновления UI.
  - **setupEventListeners()** [33-41] - Настраивает обработчики событий для навигации.
  - **handleContainerClick(e)** [47-59] - Обрабатывает клик на контейнере и определяет, был ли клик по папке.
  - **handleFolderClick(bookmarkElement)** [65-111] - Обрабатывает клик по папке и переходит в нее.
  - **handleBackButtonClick()** [116-176] - Обрабатывает клик по кнопке "Назад".
  - **updateFolderTitle(title)** [182-188] - Обновляет заголовок текущей папки.
  - **toggleBackButton(show)** [194-200] - Показывает или скрывает кнопку "Назад".
  - **showLoadingIndicator()** [205-216] - Показывает индикатор загрузки.
  - **hideLoadingIndicator()** [221-227] - Скрывает индикатор загрузки.
  - **saveNavigationState()** [232-234] - Сохраняет текущее состояние навигации в хранилище.
  - **setStack(stack)** [240-247] - Устанавливает стек навигации из сохраненного состояния. Исправлен в обновлении, чтобы использовать проверку `stack && stack.length > 0` вместо вызова несуществующего метода `isEmpty()`.
  - **getNavigation()** [252-254] - Возвращает объект навигации.
  - **getCurrentParentId()** [260-262] - Возвращает текущий ID родительской папки.

## src/modules/UIModule.js

- **UIModule** [12-156] - Класс для управления пользовательским интерфейсом.
  - **constructor(container, bookmarks)** [17-22] - Инициализирует модуль UI с контейнером и данными закладок.
  - **render(bookmarks, folderId, folderTitle)** [30-95] - Отображает закладки в зависимости от типа представления (корневое или вложенное).
  - **showEmptyMessage(isRoot)** [101-113] - Показывает сообщение о пустой папке.
  - **initializeInteractivity()** [119-122] - Инициализирует интерактивность для элементов.
  - **showLoadingIndicator()** [127-138] - Показывает индикатор загрузки.
  - **hideLoadingIndicator()** [143-149] - Скрывает индикатор загрузки.
  - **showErrorMessage(message)** [154-156] - Показывает сообщение об ошибке.
  - **showNotification(message, duration)** [162-180] - Показывает временное уведомление.
  - **showAddDialog(parentId, onItemAdded)** [186-189] - Показывает диалоговое окно добавления элемента.

## src/modules/DragDropModule.js

- **DragDropModule** [10-468] - Класс для управления перетаскиванием элементов.
  - **constructor(container, uiModule, navigationModule)** [17-37] - Инициализирует модуль с контейнером и зависимыми модулями.
  - **initDragAndDrop()** [42-53] - Инициализирует функциональность перетаскивания.
  - **handleDragStart(e)** [59-81] - Обрабатывает начало перетаскивания.
  - **handleDragEnd(e)** [87-121] - Обрабатывает завершение перетаскивания.
  - **handleDragOver(e)** [127-195] - Обрабатывает перемещение над целевым элементом.
  - **handleDragLeave(e)** [201-218] - Обрабатывает выход из целевого элемента.
  - **handleDrop(e)** [224-297] - Обрабатывает сброс перетаскиваемого элемента.
  - **setupBackButtonDropTarget()** [302-308] - Настраивает кнопку "Назад" как цель для перетаскивания.
  - **handleBackButtonDragOver(e)** [314-326] - Обрабатывает перемещение над кнопкой "Назад". Исправлен в обновлении, чтобы использовать свойство `isRoot` вместо метода `isEmpty()`.
  - **handleBackButtonDragLeave(e)** [331-333] - Обрабатывает выход из кнопки "Назад".
  - **handleBackButtonDrop(e)** [339-405] - Обрабатывает сброс на кнопку "Назад". Исправлен в обновлении, чтобы использовать свойство `isRoot` вместо метода `isEmpty()`.
  - **clearHoverEffects()** [410-424] - Очищает эффекты выделения и таймеры.

## src/modules/ContextMenuModule.js

- **ContextMenuModule** [11-243] - Класс для управления контекстным меню.
  - **constructor(uiModule, navigationModule)** [17-28] - Инициализирует модуль с зависимыми модулями.
  - **setupEventListeners()** [33-38] - Настраивает обработчики событий.
  - **handleContextMenu(e)** [44-75] - Обрабатывает событие открытия контекстного меню.
  - **\_handleMenuAction(action, element, id, isFolder, title, url)** [86-103] - Обрабатывает выбор пункта в контекстном меню.
  - **\_showBookmarkEditDialog(element, id, title, url)** [111-143] - Показывает диалог редактирования закладки.
  - **\_showFolderEditDialog(element, id, title)** [150-181] - Показывает диалог редактирования папки.
  - **\_handleDeleteAction(id, isFolder, title, url)** [189-232] - Обрабатывает действие удаления элемента.
  - **\_handleCopyAction(id, isFolder)** [239-262] - Обрабатывает действие копирования элемента.
  - **\_getFolderContentsRecursively(folderId)** [269-283] - Рекурсивно получает содержимое папки.

## src/popup.js (обновленный)

- **DOMContentLoaded** [56-71] - Обновленный обработчик загрузки документа, теперь использует модульную структуру.
- **updateUI(bookmarks, folderId, folderTitle)** [132-142] - Обновляет интерфейс через модуль UIModule.
- **handleBackButtonClick()** [145-153] - Обработчик кнопки "Назад" через модуль NavigationModule.
- **showLoadingIndicator()** [156-170] - Показывает индикатор загрузки через модуль UIModule или запасной вариант.
- **hideLoadingIndicator()** [173-181] - Скрывает индикатор загрузки через модуль UIModule или запасной вариант.
- **showErrorMessage(message)** [184-192] - Показывает сообщение об ошибке через модуль UIModule или запасной вариант.
- **initializeUI()** [197-244] - Обновленная инициализация интерфейса с использованием модулей.
- **initEventListeners()** [249-277] - Инициализирует обработчики событий для глобальных событий.
- **refreshCurrentView(forceUpdateCache)** [282-331] - Обновляет текущее представление через модули.
- **handleThemeToggle(e)** [336-346] - Обработчик переключения темы.

## DragDropModule.js (обновлено)

### handleDragOver (91-171)

Обработчик перетаскивания элементов над потенциальными целями. Реализует интеллектуальное определение зон перетаскивания:

- Боковые 20% элемента для перемещения до/после элемента с визуальным смещением
- Центральные 60% для папок - определяет перемещение внутрь папки
- Отображает подсказки в зависимости от зоны перетаскивания
- Четко разделяет варианты перемещения с визуальной обратной связью

### handleDrop (175-265)

Обрабатывает момент завершения перетаскивания и выполняет соответствующие действия:

- Анализирует классы и атрибуты целевого элемента для определения типа перемещения
- Вызывает специализированные методы в зависимости от типа операции
- Логирует все действия для отладки
- Гарантированно очищает все эффекты даже при ошибках (блок finally)

### reorderBeforeTarget (270-300)

Перемещает элемент перед указанным целевым элементом:

- Находит целевой элемент по ID
- Визуально выполняет перемещение немедленно для лучшего UX
- Вызывает API для сохранения изменений
- Восстанавливает исходное положение при ошибке

### moveToEndOfList (305-330)

Перемещает элемент в конец списка текущей папки:

- Визуально перемещает элемент в конец списка сразу
- Вызывает API с targetId=null для перемещения в конец
- Обрабатывает ошибки с возвратом элемента на исходную позицию

### moveIntoFolder (335-355)

Перемещает элемент внутрь указанной папки:

- Удаляет элемент из DOM немедленно
- Вызывает API для перемещения элемента внутрь папки
- Обновляет представление после успешного перемещения

### clearHoverEffects (410-425)

Очищает все визуальные эффекты перетаскивания:

- Сбрасывает трансформации элементов для плавного возврата
- Удаляет классы индикаторов перетаскивания
- Сбрасывает атрибуты подсказок
- Очищает таймеры для открытия папок

### showDraggingTooltip (565-583)

Отображает контекстную подсказку при перетаскивании элементов для улучшения UX:

- Показывает конкретные инструкции для каждой из зон перетаскивания
- Автоматически исчезает через определенное время

### handleKeyDown (515-525)

Обрабатывает нажатия клавиш во время перетаскивания:

- ESC - отменяет операцию перетаскивания

### cancelDragging (530-553)

Отменяет текущую операцию перетаскивания:

- Очищает все визуальные эффекты
- Сбрасывает состояние перетаскивания
- Восстанавливает исходное положение элементов

### destroy (558-583)

Освобождает ресурсы, удаляет обработчики событий:

- Очищает таймеры
- Удаляет обработчики клавиш
- Удаляет элементы подсказок
- Сбрасывает все переменные модуля

## Style improvements for drag-and-drop

### Визуальные эффекты в fixes.css

- Плавное смещение элементов при наведении на зоны перетаскивания (transform: translateX)
- Анимированные переходы для всех трансформаций (transition: transform 0.2s ease-out)
- Масштабирование для элемента, который в данный момент перетаскивается
- Выделение папок при наведении на них в центральной зоне

## Улучшения drag-and-drop функциональности

### src/modules/DragDropModule.js

- **handleMouseDown(e)** [90-118] - Обрабатывает нажатие кнопки мыши на элементе, определяет начало потенциального перетаскивания. Использует задержку и проверку смещения для определения клика vs перетаскивания.
- **handleMouseMoveGlobal(e)** [124-155] - Отслеживает движение мыши после нажатия для определения начала перетаскивания на основе порогового значения смещения.
- **handleMouseUp(e)** [161-171] - Обрабатывает отпускание кнопки мыши, очищает таймеры и временные классы, если не началось перетаскивание.
- **handleDragStart(e)** [177-217] - Улучшенный обработчик начала перетаскивания, добавляет плавные анимации и классы для CSS-эффектов.
- **handleDragEnd(e)** [221-256] - Улучшенный обработчик завершения перетаскивания с плавным переходом и очисткой состояний.
- **handleDragOver(e)** [267-439] - Улучшенный обработчик для перемещения над целевыми элементами с зонами определения позиции для вставки и улучшенной визуальной обратной связью.
- **handleDragEnter(e)** [438-457] - Обработчик входа курсора в элемент, отслеживает время наведения на папку.
- **handleDragLeave(e)** [461-543] - Улучшенный обработчик выхода из элемента с проверкой фактического выхода курсора с использованием расширенных границ элемента.
- **clearEffectsForElement(element)** [550-586] - Плавно очищает эффекты для конкретного элемента с анимацией.
- **handleDrop(e)** [573-748] - Обработчик сброса элемента с интеллектуальным определением позиции вставки.
- **showDraggingTooltip(text)** [564-582] - Показывает информативную подсказку во время перетаскивания.
- **hideDraggingTooltip()** [586-590] - Скрывает подсказку о перетаскивании.
- **cancelDragging()** [532-558] - Отменяет текущую операцию перетаскивания по нажатию клавиши Escape.

### src/styles/fixes.css

- **Улучшения для drag & drop** [99-190] - Добавлены новые стили для плавной анимации, GPU-ускорения, предотвращения дрожания при перетаскивании:
  - **Базовые улучшения** [100-115] - Использование will-change, backface-visibility, transform-style и contain для оптимизации производительности.
  - **Анимации пульсации** [118-140] - Добавлены эффекты подсветки курсора для разных тем.
  - **Изменение курсора** [143-159] - Улучшенное поведение курсора при перетаскивании с цветовой индикацией.
  - **Визуальный эффект для элементов** [164-231] - Анимации, тени и подсветка для перетаскиваемых элементов.
  - **Индикаторы drag-and-drop** [250-268] - Стили для индикаторов позиции вставки.
  - **Подсказки и обратная связь** [271-343] - Стили для информативных подсказок и эффектов при перетаскивании.

### Изменения в логике работы:

1. **Улучшен механизм определения перетаскивания vs клика** - Добавлена задержка (150 мс) и проверка смещения (5 пикселей) для предотвращения случайных перетаскиваний.
2. **Добавлена расширенная зона обнаружения курсора** - Для предотвращения дрожания при перетаскивании используются расширенные границы элементов.
3. **Улучшена логика падения элемента в папку** - Теперь элемент перемещается в папку только при отпускании кнопки мыши, а не автоматически по таймеру.
4. **Добавлены информативные подсказки** - Показывают пользователю, что произойдет при отпускании элемента в текущей позиции.
5. **Оптимизирована производительность** - Использованы техники GPU-ускорения и дебаунсинга для улучшения плавности анимаций.
6. **Улучшено определение зон вставки** - Элементы интерфейса разделены на логические зоны для более точного определения позиции вставки.
7. **Добавлена возможность отмены перетаскивания** - По нажатию клавиши Escape операция перетаскивания отменяется.
8. **Улучшена цветовая индикация** - Добавлены различные цвета для светлой (оранжевый) и темной (бирюзовый) тем.
