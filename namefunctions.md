# Функции расширения Chrome для закладок

## Обновления и исправления

- **Заменены иконки выравнивания текста и списков в редакторе заметок** - В `src/components/NoteModal.js`:

  - [633-676] — заменены SVG-иконки кнопок выравнивания на логотипы из файлов
  - [782-790] — заменены текстовые иконки списков (маркированного и нумерованного) на логотипы из файлов
  - Добавлены отдельные версии иконок для светлой и темной тем
  - В `src/styles/main.css` добавлены соответствующие стили для корректного отображения иконок

- **Исправления стилей для диалога добавления элементов** - Добавлен новый файл `src/styles/fixes.css` для исправления визуальных проблем в диалоге добавления папок и закладок.

- **Улучшен механизм локализации** - В методе `t` класса `I18n` добавлена обработка случаев отсутствия перевода, теперь метод возвращает форматированную последнюю часть ключа.

- **Добавлены новые ключи локализации** - В файлы локализации `src/locales/ru.js` и `src/locales/en.js` добавлены ключи для кнопок добавления папок и закладок.

- **Улучшен интерфейс выравнивания текста в редакторе заметок** в `src/components/NoteModal.js` [630-674] - Вместо четырех отдельных кнопок добавлена одна выпадающая кнопка с меню стиля Google Документов. Меню содержит четыре варианта выравнивания с наглядными иконками и подписями. Добавлены визуальные эффекты при наведении и выборе.

- **Улучшена стилизация скроллбара в режиме просмотра заметок** в `src/components/NoteModal.js` и `src/styles/main.css` [1761-1792] - Удалены JavaScript-вставки стилей для скроллбара и заменены на CSS-классы. Добавлены переменные `--scrollbar-track`, `--scrollbar-track-dark` и `--scrollbar-thumb-hover` в корневые CSS-переменные для единообразного стиля скроллбаров во всем приложении. Улучшена совместимость между WebKit-браузерами и стандартными браузерами через комбинацию CSS-свойств scrollbar-width/scrollbar-color и ::-webkit-scrollbar.

- **Улучшены кнопки выравнивания текста в редакторе заметок** в `src/components/NoteModal.js` [630-674] - Заменены иконки стрелок на изображения полосок для интуитивного понимания типа выравнивания. Отключено изменение фона кнопок при активации для более аккуратного внешнего вида (функция state возвращает false).

- **Добавлена функциональность выравнивания текста в редакторе заметок** в `src/components/NoteModal.js` [630-674] - Добавлены четыре кнопки для выравнивания текста: по левому краю (justifyLeft), по центру (justifyCenter), по правому краю (justifyRight) и по ширине (justifyFull). Для каждой кнопки добавлена соответствующая иконка и всплывающая подсказка. Добавлена поддержка локализации для названий кнопок.

- **Исправлена функция диалога редактирования папок** [504-657] в `popup.js` - Восстановлена возможность загрузки пользовательских иконок для папок.

- **Исправлена функция отображения папок с учетом темы** в `src/components/MainInterface.js` и `src/components/NestedMenu.js` - Исправлено отображение иконок папок для темной темы.

- **Улучшен интерфейс редактора заметок** в `src/components/NoteModal.js` [60-130] и `src/styles/main.css` [1410-1555] - Оптимизирована шапка редактора, уменьшена до 20px, добавлено отображение заголовка заметки в шапке, улучшены стили редактора Pell для более компактного отображения.

- **Расширена функциональность редактора заметок** в `src/components/NoteModal.js` [140-210] и `src/styles/main.css` [1470-1550] - Увеличены отступы текста от границ редактора, добавлены стили для корректного отображения ссылок и выделенного текста, добавлен обработчик для открытия ссылок в новой вкладке при клике, улучшен внешний вид редактора.

- **Добавлен режим просмотра/редактирования заметок** в `src/components/NoteModal.js` [25-300] и `src/styles/main.css` [1556-1630] - Реализованы два режима работы с заметками: режим просмотра (по умолчанию) и режим редактирования. В режиме просмотра заметка отображается без панели редактирования, а переключение в режим редактирования осуществляется по кнопке "Редактировать". После сохранения изменений осуществляется возврат в режим просмотра. Добавлены методы `switchToEditMode()` [195-215] и `switchToViewMode()` [217-235] для переключения между режимами.

- **Улучшен интерфейс заметок** в `src/styles/main.css` [1500-1550] - Убран фон для панели редактора, чтобы не выделялся на основном фоне. Кнопка "Редактировать" перемещена в верхнюю часть заметки для лучшей визуальной организации интерфейса. Панель инструментов редактора более гармонично интегрирована в общий дизайн.

- **Добавлена поддержка изменения цвета текста** в `src/components/NoteModal.js` [240-280] - Добавлены кнопки для изменения цвета текста (foreColor) и цвета фона текста (backColor) в панель инструментов редактора. Включен параметр `styleWithCSS: true` для корректной работы с цветами. Пользователь может ввести любой цвет в формате HEX (#24ffd0) или по имени (red, blue).

- **Улучшена система выбора цвета в редакторе заметок** в `src/components/NoteModal.js` [240-392] - Реализована всплывающая палитра с 20 предопределенными цветами для выбора цвета текста и фона. Добавлены стилизованные кнопки с наглядным отображением: для цвета текста красная буква "A", для цвета фона - белая буква "A" на красном фоне. Палитра появляется при клике на соответствующую кнопку и автоматически скрывается при выборе или клике вне её.

- **Добавлена кнопка сброса цвета в палитру выбора цвета** в `src/components/NoteModal.js` [285-300, 470-485] - Добавлена кнопка "Сбросить" в палитры выбора цвета текста и фона. Кнопка позволяет вернуть цвет текста к наследуемому от CSS (inherit) и цвет фона к прозрачному (transparent). Кнопка стилизована в соответствии с общим дизайном и расположена между палитрой цветов и полем ввода собственного цвета.

- **Исправлена конфигурация в constants.js** - Добавлен идентификатор для кнопки корзины и исправлена структура кнопок добавления.

- **Добавлена функция `optimizeImage(file)`** [658-716] в `popup.js` - Оптимизирует загруженные изображения для использования в качестве иконок папок.

- **chrome.storage API** - Исправлено единообразное использование `chrome.storage.local` вместо `chrome.storage.sync` во всех файлах проекта для последовательного хранения настроек темы, языка и состояния навигации. Обновленные файлы: `src/utils/i18n.js`, `src/utils/theme.js`, `src/trash.js`, `src/settings.js`, `src/components/MainInterface.js`, `src/components/NestedMenu.js`.

- **Добавлена функция `showAddDialog(parentId)`** [717-763] в `popup.js` - Показывает диалог выбора типа элемента для добавления (закладка или папка).

- **Добавлена функция `showCreateFolderDialog(parentId)`** [764-801] в `popup.js` - Показывает диалог создания новой папки.

- **Добавлена функция `showCreateBookmarkDialog(parentId)`** [802-840] в `popup.js` - Показывает диалог создания новой закладки.

- **Добавлены новые функции в src/modules/DragDropModule.js для улучшения drag-and-drop**

  - **setupDragZoneObserver()** [40-70] - Настраивает MutationObserver для автоматического добавления зон перетаскивания для новых элементов.
  - **setupDragZonesForAllElements()** [75-82] - Настраивает зоны перетаскивания для всех существующих элементов.
  - **setupDragZonesForElement(element)** [87-104] - Настраивает зоны перетаскивания для отдельного элемента, включая центральную зону для папок.
  - Улучшена логика в **handleDragOver(e)** [268-443] - Изменен принцип определения зон с вертикального на горизонтальный, добавлена логика левого края/середины/правого края для папок и левого/правого края для закладок.
  - Улучшена логика в **handleMouseMoveGlobal(e)** [160-180] - Удалено изменение курсора при перетаскивании для более консистентного пользовательского опыта, курсор всегда остается обычным (default).
  - Изменена логика в **handleMouseUp(e)** и **handleDragStart(e)** для корректной работы с атрибутом draggable и поддержания обычного курсора во время всего процесса перетаскивания.
  - Улучшена логика в **handleDrop(e)** [564-747] - Обновлена обработка перетаскивания в соответствии с новой системой горизонтальных зон.

- **Добавлены новые стили в src/styles/fixes.css для drag-and-drop**
  - Улучшенные стили для индикации перетаскивания (трансформации для drop-target, drop-target-above, highlight).
  - Добавлены стили для центральной зоны папки .folder-center-zone с анимацией пульсации.
  - Добавлены CSS-селекторы для горизонтальных хитбоксов (::before, ::after) с разделением зон по ширине.
  - Оптимизированы стили для пустых областей и плавного перемещения элементов.

## Обновления и исправления (Исправление ошибок дублирования функций)

- **Исправление ошибки дублирования функций в bookmarks.js**

  - Решена проблема с ошибкой `SyntaxError: Identifier 'generateBookmarksHTML' has already been declared` путем удаления дублирующейся функции.
  - Переименована внутренняя функция `processBookmarkTree` в `processBasicBookmarkTree` для устранения конфликта с экспортируемой версией.
  - Обновлены номера строк в документации для функций, связанных с обработкой заметок.

- **Улучшение функционала заметок:**
  - Функция `generateBookmarksHTML` [341-381] в `src/utils/bookmarks.js` обновлена для поддержки заметок в HTML-экспорте.
  - Функция `processBasicBookmarkTree` [295-337] - базовая функция для импорта закладок из браузера.
  - Функция `processBookmarkTreeWithNotes` [374-434] - расширенная функция для импорта с поддержкой заметок.
  - Экспортируемая функция `processBookmarkTree` [436-438] теперь использует `processBookmarkTreeWithNotes`.

## src/utils/bookmarks.js

- **getAllBookmarks(forceUpdate)** [8-44] - Получает все закладки из хранилища с опциональным принудительным обновлением, реализует кеширование данных для оптимизации (30 секунд).
- **createBookmark(parentId, title, url)** [47-49] - Создает новую закладку в указанной родительской папке.
- **createFolder(parentId, title)** [52-54] - Создает новую папку в указанной родительской папке.
- **getBookmarksInFolder(folderId, forceUpdate)** [57-121] - Получает закладки из конкретной папки с опциональным принудительным обновлением, использует кеширование.
  - **findFolder(items)** [80-90] - Вспомогательная внутренняя функция для поиска папки в дереве закладок.
- **importFromBrowser()** [124-147] - Импортирует закладки из браузера Chrome и сохраняет их в локальное хранилище расширения.
- **processBookmarkTree(bookmarks)** [150-177] - Рекурсивно обрабатывает дерево закладок из браузера при импорте (вспомогательная функция для importFromBrowser).
- **generateUniqueId()** [179-181] - Генерирует уникальный ID для новых закладок и папок.
- **exportBookmarksToHTML()** [184-191] - Экспортирует закладки в формат HTML (стандартный формат экспорта закладок браузера).
- **generateBookmarksHTML(bookmarks, level)** [194-217] - Генерирует HTML разметку для экспорта закладок (вспомогательная функция для exportBookmarksToHTML).
- **updateBookmark(id, data)** [225-262] - Обновляет существующую закладку или папку по ID, устанавливая новые данные (название, URL).
  - **updateInTree(items)** [280-292] - Вспомогательная внутренняя функция для поиска и обновления элемента в дереве закладок.
- **deleteBookmark(bookmarkId)** [267-296] - Удаляет закладку или папку по ID.
  - **deleteFromTree(items)** [317-336] - Вспомогательная внутренняя функция для поиска и удаления элемента из дерева закладок.
- **copyBookmark(id, parentId)** [301-351] - Копирует папку или закладку в указанную родительскую папку.
  - **findInTree(items)** [359-371] - Вспомогательная внутренняя функция для поиска элемента в дереве закладок.
  - **findParentFolder(items, targetId)** [372-384] - Вспомогательная внутренняя функция для поиска родительской папки.
  - **generateNewId()** [385-387] - Вспомогательная внутренняя функция для генерации нового ID.
  - **deepClone(item)** [389-396] - Вспомогательная внутренняя функция для глубокого клонирования элемента с новыми ID.
- **updateFolder(id, data)** [356-379] - Обновляет существующую папку (название, иконка).
  - **updateInTree(items)** [433-446] - Вспомогательная внутренняя функция для поиска и обновления папки в дереве закладок.
- **moveBookmark(itemId, targetFolderId)** [386-460] - Перемещает закладку или папку в другую папку.
  - **findAndExtractItem(items, parentPath)** [491-512] - Вспомогательная внутренняя функция для поиска и извлечения элемента из дерева.
  - **addToTargetFolder(items)** [522-534] - Вспомогательная внутренняя функция для добавления элемента в целевую папку.
- **isChildFolder(bookmarks, sourceId, targetId)** [467-490] - Проверяет, является ли целевая папка подпапкой исходной (предотвращает циклические ссылки при перемещении).
  - **checkInFolder(items)** [572-578] - Вспомогательная внутренняя функция для поиска исходной папки.
  - **isDescendant(folder)** [580-589] - Вспомогательная внутренняя функция для проверки вложенности папок.
- **findFolderById(bookmarks, folderId)** [497-508] - Находит папку по ID в дереве закладок.
- **reorderBookmarks(sourceId, targetId, parentId)** [516-637] - Меняет порядок закладок в указанной папке.
  - **findFolder(items)** [650-661] - Вспомогательная внутренняя функция для поиска папки по ID.
  - **verifyInFolder(items)** [760-785] - Вспомогательная внутренняя функция для проверки успешности операции.
- **isChildOf(parentId, childId)** [644-704] - Проверяет, является ли папка потомком (непосредственным или вложенным) другой папки.
  - **checkIsChild(items, targetId)** [656-668] - Вспомогательная внутренняя функция для проверки вхождения элемента в папку.
  - **findFolder(items, id)** [671-686] - Вспомогательная внутренняя функция для поиска папки по ID.
- **createNote** (строки 130-165) - Создает новую заметку с указанным заголовком и содержимым в указанной папке. Принимает parentId, title и content, возвращает созданную заметку или null при ошибке.
- **createStoredNote** (строки 173-227) - Вспомогательная функция для создания заметки в хранилище. Принимает parentId, title, content и createdAt, создает объект заметки и сохраняет его в дереве закладок.
- **updateNote** (строки 235-271) - Обновляет существующую заметку. Принимает id заметки и объект data с новыми значениями полей (title, content).
- **generateBookmarksHTML** (обновлена для поддержки заметок, строки 280-310) - Генерирует HTML-представление закладок, включая специальный формат для заметок.
- **processBookmarkTree** (обновлена для поддержки заметок, строки 318-368) - Обрабатывает дерево закладок при импорте, распознает и импортирует заметки.

## src/utils/errorHandler.js

- **ErrorType** [2-12] - Объект с константами для типов ошибок (CREATE, UPDATE, DELETE, COPY, LOAD, NAVIGATION, MOVE, RESTORE, REORDER).
- **errorMessages** [15-49] - Объект с сообщениями об ошибках для различных типов и подтипов ошибок.
- **ErrorHandler.handle(error, type, subtype)** [56-67] - Статический метод для обработки ошибок с выводом сообщения пользователю и логированием в консоль.
- **ErrorHandler.wrapAsync(promise, type, subtype)** [69-75] - Статический метод-обертка для асинхронных функций, автоматически обрабатывающий ошибки с помощью ErrorHandler.handle.

## src/utils/i18n.js

- **I18n** [4-56] - Класс для интернационализации приложения.
  - **constructor()** [5-11] - Инициализирует объект с русской локалью по умолчанию, загружает переводы и настраивает систему слушателей.
  - **initLocale()** [13-19] - Асинхронно инициализирует локаль из хранилища Chrome.
  - **setLocale(locale)** [21-25] - Устанавливает новую локаль и сохраняет её в хранилище Chrome.
  - **t(key, params)** [27-45] - Возвращает перевод по указанному ключу с опциональной подстановкой параметров.
  - **addListener(callback)** [47-49] - Добавляет слушателя изменений локали.
  - **removeListener(callback)** [51-53] - Удаляет слушателя изменений локали.
  - **\_notifyListeners()** [55-59] - Уведомляет всех слушателей об изменении локали.
- **i18n** [64] - Экспортированный экземпляр класса I18n для использования во всем приложении.

## src/utils/navigation.js

- **Navigation** [1-58] - Класс для управления навигацией по папкам закладок.
  - **constructor()** [2-5] - Инициализирует пустой стек навигации и набор слушателей.
  - **currentFolder** [getter, 7-9] - Возвращает текущую папку (последнюю в стеке).
  - **isRoot** [getter, 11-13] - Проверяет, находимся ли в корневой папке.
  - **getStack()** [15-17] - Возвращает копию текущего стека навигации.
  - **setStack(newStack)** [19-22] - Устанавливает новый стек навигации.
  - **push(folder)** [24-27] - Добавляет папку в стек навигации и уведомляет слушателей.
  - **pop()** [29-35] - Возвращается на уровень вверх (удаляет последнюю папку из стека).
  - **clear()** [37-40] - Очищает стек навигации (возвращает в корень).
  - **getCurrentParentId()** [46-48] - Возвращает ID текущей родительской папки.
  - **addListener(callback)** [50-52] - Добавляет слушателя изменений навигации.
  - **removeListener(callback)** [54-56] - Удаляет слушателя изменений навигации.
  - **\_notifyListeners()** [58-62] - Уведомляет всех слушателей об изменении навигации.

## src/utils/theme.js

- **initTheme()** [1-28] - Инициализирует систему тем (темная/светлая) и устанавливает обработчики переключения.
- **setTheme(isDark)** [30-39] - Устанавливает темную или светлую тему и сохраняет выбор в хранилище Chrome.

## src/utils/window.js

- **DOMContentLoaded event listener** [2-10] - Устанавливает фиксированные размеры окна расширения при загрузке документа.

## src/utils/storage.js

- **Storage** [2-47] - Класс для работы с локальным хранилищем Chrome.
  - **constructor()** [3-6] - Инициализирует хранилище с ключом "gh_bookmarks".
  - **initializeStorage()** [8-30] - Проверяет наличие закладок в хранилище и создает начальную структуру с базовыми папками, если необходимо.
  - **get(key)** [32-38] - Получает данные из хранилища Chrome по ключу.
  - **set(key, value)** [40-46] - Сохраняет данные в хранилище Chrome по ключу.
- **storage** [50] - Экспортированный экземпляр класса Storage для использования во всем приложении.
- **getStoredBookmarks()** [53-56] - Получает все закладки из хранилища.
- **createStoredBookmark(parentId, title, url)** [59-108] - Создает новую закладку или папку в хранилище.
  - **addToFolder(items)** [94-106] - Вспомогательная внутренняя функция для добавления закладки в папку.
- **getBookmarksFromFolder(folderId)** [111-133] - Получает закладки из указанной папки.
  - **findFolder(items)** [118-130] - Вспомогательная внутренняя функция для поиска папки по ID.
- **saveBookmarks(bookmarks)** [136-138] - Сохраняет все закладки в хранилище.
- **getFavicon(url)** [141-172] - Получает иконку для URL (favicon) сначала через Google Favicon Service, затем напрямую с сайта.
- **generateUniqueId()** [175-177] - Генерирует уникальный ID для новых закладок и папок.
- **findFolderById(bookmarks, folderId)** [179-189] - Находит папку в дереве закладок по ID.
- **addBookmarkToFolder(bookmarks, parentId, newBookmark)** [191-204] - Добавляет закладку в указанную папку с сохранением структуры дерева.
- **createStoredNote** (строки 173-227) - Вспомогательная функция для создания заметки в хранилище. Принимает parentId, title, content и createdAt, создает объект заметки и сохраняет его в дереве закладок.
- **getFavicon(url)** [254-313] - Добавлена мультистратегия получения фавиконов с использованием Chrome Favicon API, Google Favicon Service и прямого доступа к favicon.ico. Также улучшена обработка ошибок и валидация URL.
- **findFolderById(bookmarks, folderId)** [179-189] - Находит папку в дереве закладок по ID.
- **addBookmarkToFolder(bookmarks, parentId, newBookmark)** [191-204] - Добавляет закладку в указанную папку с сохранением структуры дерева.
- **createStoredNote** (строки 173-227) - Вспомогательная функция для создания заметки в хранилище. Принимает parentId, title, content и createdAt, создает объект заметки и сохраняет его в дереве закладок.
- **updateBookmarkFavicon(bookmarkId)** [823-896] - Функция для принудительного обновления фавикона отдельной закладки по её ID. Ищет закладку в дереве, получает свежий фавикон с использованием функции getFavicon и обновляет данные закладки. Добавлена для поддержки опции обновления фавикона в контекстном меню закладки.
- **getFavicon** [421-549] - Функция для получения фавикона сайта. Оптимизирована для быстрой работы:
  - Использует сервис Google Favicon (`https://www.google.com/s2/favicons?domain=`) для надежного получения фавиконов
  - Удалены медленные методы с множественными запросами (HTML парсинг, проверка путей)
  - Исправлена проблема с невозможностью отображения `chrome://favicon/` URL в элементах `<img>`
- **getFaviconFast(url)** [934-1070] - Быстрая функция получения фавиконов высокого качества:
  - Специальная обработка для YouTube, Google Docs и других сервисов Google
  - Используются статические ссылки на фавиконы для популярных сайтов
  - Распознаёт различные типы документов Google и YouTube видео
  - Улучшена поддержка URL для Google Docs вида document/d/ID/edit
  - Поддерживает кэширование в памяти для ускорения повторных запросов
  - Содержит резервный вариант через Google Favicon Service для любых неизвестных сайтов
- **updateAllFavicons(progressCallback)** [640-755] - Функция массового обновления фавиконов:
  - Параллельная обработка закладок для ускорения обновления
  - Ограничение количества одновременных запросов для контроля нагрузки
  - Использует getFaviconFast для быстрого получения фавиконов
  - Поддерживает отслеживание прогресса через callback функцию

## src/background.js

- **chrome.runtime.onInstalled** [2-34] - Обработчик события установки расширения. Инициализирует настройки по умолчанию и базовую структуру папок закладок.
- **chrome.runtime.onMessage** [2-91] - Обработчик сообщений от popup. Обрабатывает запросы на экспорт закладок, получение HTML-контента страницы, извлечение фавиконов из HTML и проверку доступности фавиконов по стандартным путям.
- **fetchHtmlContent** [92-113] - Функция для получения HTML-контента страницы с обходом ограничений CORS.
- **extractFaviconsFromHTML** [114-175] - Функция для извлечения ссылок на фавиконы из HTML-документа.
- **checkFaviconPaths** [176-217] - Функция для проверки доступности фавиконов по известным путям.

## src/settings.js

- **DOMContentLoaded** [6-58] - Инициализирует UI страницы настроек, устанавливает обработчики событий.
- **updateLanguageToggle()** [61-64] - Обновляет состояние переключателя языка в соответствии с текущим языком.
- **translatePage()** [67-72] - Переводит все элементы страницы с атрибутом data-translate на текущий язык.
- **handleThemeToggle(e)** [75-81] - Обработчик переключения темы оформления.
- **importBookmarksFromBrowser()** [84-91] - Импортирует закладки из браузера Chrome.
- **exportBookmarksToFile()** [94-117] - Экспортирует закладки в HTML-файл.
- **generateBookmarksHTML(bookmarks)** [120-152] - Генерирует HTML-код для экспорта закладок.
  - **generateBookmarkItem(item, indent)** [136-147] - Вспомогательная внутренняя функция для генерации HTML разметки отдельной закладки или папки.
- **importBookmarksFromFile(file)** [155-163] - Импортирует закладки из HTML-файла.
- **readFileContent(file)** [166-172] - Читает содержимое файла.
- **parseBookmarksHTML(html)** [175-228] - Парсит HTML-файл с закладками.
  - **processNode(node)** [178-216] - Вспомогательная внутренняя функция для обработки узлов HTML и извлечения закладок.

## src/trash.js

- **DOMContentLoaded** [8-21] - Инициализирует страницу корзины, устанавливает локализацию.
- **translatePage()** [23-29] - Переводит все элементы страницы на текущий язык.
- **initializeUI()** [31-83] - Инициализирует интерфейс страницы корзины, устанавливает обработчики событий.
- **handleThemeToggle(e)** [85-91] - Обработчик переключения темы оформления.
- **renderTrashItems()** [93-158] - Отрисовывает элементы корзины на странице.
- **restoreContents(parentId, contents)** [160-177] - Рекурсивно восстанавливает содержимое удаленной папки.
- **handleRestore(item)** [179-242] - Обрабатывает восстановление элемента из корзины.

## src/services/TrashStorage.js

- **TrashStorage** [1-134] - Класс для работы с хранилищем удаленных элементов (корзина).
  - **constructor()** [2-6] - Инициализирует хранилище с именем базы данных и хранилища.
  - **init()** [8-30] - Инициализирует IndexedDB для хранения удаленных элементов.
  - **moveToTrash(item, navigationStack)** [32-53] - Перемещает элемент в корзину с сохранением пути навигации.
  - **restoreItem(id)** [55-76] - Восстанавливает элемент из корзины.
  - **getTrashItems()** [78-93] - Получает все элементы из корзины.
  - **clearTrash()** [95-110] - Очищает корзину.
  - **hasItems()** [112-120] - Проверяет, есть ли элементы в корзине.
- **trashStorage** [138] - Экспортированный экземпляр класса TrashStorage для использования во всем приложении.

## src/services/IconStorage.js

- **IconStorage** [1-110] - Класс для работы с хранилищем иконок папок.
  - **constructor()** [2-7] - Инициализирует свойства для работы с IndexedDB.
  - **init()** [9-28] - Инициализирует базу данных IndexedDB для хранения иконок.
  - **saveIcon(folderId, iconBlob)** [30-47] - Сохраняет иконку папки в хранилище.
  - **getIcon(folderId)** [49-64] - Получает иконку папки из хранилища.
  - **deleteIcon(folderId)** [66-81] - Удаляет иконку папки из хранилища.
  - **migrateFromStorage()** [83-107] - Мигрирует иконки из Chrome Storage в IndexedDB.
- **iconStorage** [110] - Экспортированный экземпляр класса IconStorage для использования во всем приложении.

## src/locales/ru.js

- **default export** [1-79] - Объект с переводами на русский язык, структурированный по разделам интерфейса (модальные окна, кнопки, метки, подтверждения, валидация, сообщения, настройки, корзина, ошибки, drag-and-drop).
  - Добавлен ключ **UPDATE_FAVICON** [24] в секцию BUTTONS для отображения на русском языке опции обновления фавикона.

## src/locales/en.js

- **default export** [1-79] - Объект с переводами на английский язык, структурированный по тем же разделам, что и в ru.js.
  - Добавлен ключ **UPDATE_FAVICON** [24] в секцию BUTTONS для отображения на английском языке опции обновления фавикона.

## src/config/constants.js

- **ICONS** [2-23] - Объект с путями к иконкам для различных элементов интерфейса с учетом темы (светлая/темная).
  - Добавлена новая иконка **UPDATE_FAVICON** [21-24] для функции обновления фавикона в контекстном меню закладки.
- **UI_TEXTS** [26-56] - Объект с текстами интерфейса, сгруппированными по назначению (модальные окна, кнопки, метки, подтверждения).
- **CONTEXT_MENU_CONFIG** [59-88] - Конфигурация контекстного меню для папок и закладок.
  - Обновлена иконка для действия **update_favicon** [85-88] с использованием специальной иконки вместо стандартной иконки ссылки.
- **ADD_BUTTONS_CONFIG** [91-106] - Конфигурация кнопок добавления для разных типов элементов.
- **STORAGE_KEYS** [109-112] - Ключи для хранилища Chrome.
- **DOM_IDS** [115-122] - ID HTML-элементов для доступа в JavaScript.
- **CSS_CLASSES** [125-131] - CSS-классы, используемые в приложении.

## src/components/NestedMenu.js

- **NestedMenu** [4-100] - Класс для отображения вложенного меню закладок.
  - **constructor(container, bookmarks)** [5-8] - Инициализирует компонент с контейнером и данными закладок.
  - **getCurrentTheme()** [11-17] - Асинхронно получает текущую тему из хранилища Chrome.
  - **getDefaultFolderIcon()** [20-23] - Возвращает путь к иконке папки по умолчанию в зависимости от темы.
  - **getFolderIcon(folderId)** [25-35] - Получает иконку папки из хранилища или возвращает иконку по умолчанию.
  - **render()** [37-96] - Отрисовывает меню с закладками и папками в контейнере.
  - **destroy()** [98-100] - Очищает контейнер и удаляет CSS-класс.

## src/components/Modal.js

- **Modal** [3-167] - Класс для работы с модальными окнами.
  - **constructor()** [4-8] - Инициализирует объект модального окна.
  - **create(title, type, initialData, customContent)** [10-92] - Создает модальное окно с заданными параметрами.
  - **createInputGroup(id, label, value)** [94-110] - Создает группу ввода с меткой и полем ввода.
  - **handleSave(type)** [112-125] - Обрабатывает сохранение данных из модального окна.
  - **close()** [127-133] - Закрывает модальное окно и удаляет его из DOM.
  - **show(title, type, initialData, onSave, onClose, customContent)** [135-139] - Показывает модальное окно с заданными параметрами и обработчиками.

## src/components/MainInterface.js

- **MainInterface** [4-121] - Класс для отображения основного интерфейса закладок.
  - **constructor(container, bookmarks)** [5-8] - Инициализирует компонент с контейнером и данными закладок.
  - **getCurrentTheme()** [11-17] - Асинхронно получает текущую тему из хранилища Chrome.
  - **getCustomFolderIcon(folderId)** [20-30] - Получает пользовательскую иконку папки из хранилища.
  - **getDefaultFolderIcon()** [33-36] - Возвращает путь к иконке папки по умолчанию в зависимости от темы.
  - **getFolderIcon(folderId)** [38-48] - Получает иконку папки из хранилища или возвращает иконку по умолчанию.
  - **render()** [50-118] - Отрисовывает закладки и папки в контейнере, обрабатывает пустой список.

## src/components/ContextMenu.js

- **ContextMenu** [3-99] - Класс для работы с контекстным меню.
  - **constructor()** [4-29] - Инициализирует объект контекстного меню и устанавливает обработчики его закрытия.
  - **close()** [31-38] - Закрывает контекстное меню.
  - **show(x, y, items, target, onAction)** [40-97] - Показывает контекстное меню в указанных координатах с заданными элементами.

## src/libs/Sortable.min.js

Подключена внешняя библиотека Sortable.js (версия 1.15.0) для реализации функциональности drag-and-drop. Библиотека обеспечивает возможность перетаскивания элементов, сортировку списков и другие операции с интерактивными элементами интерфейса.

## src/popup.js

- **DOMContentLoaded** [56-105] - Обработчик события загрузки документа. Инициализирует хранилище иконок, тему, обрабатывает параметр пути и настраивает локализацию.
- **translatePage()** [114-120] - Переводит элементы интерфейса с атрибутом data-translate на текущий язык.
- **getFolderContentsRecursively(folderId)** [123-132] - Рекурсивно получает содержимое папки, включая все вложенные папки.
- **handleFolderClick(bookmarkElement)** [134-188] - Обрабатывает клик по папке, загружает её содержимое и обновляет UI.
- **handleBackButtonClick()** [190-279] - Обрабатывает нажатие кнопки "Назад", возвращаясь на предыдущий уровень навигации.
- **handleContextMenu(e)** [281-403] - Показывает контекстное меню при правом клике на закладке или папке с опциями редактирования, удаления и копирования.
- **handleThemeToggle(e)** [404-420] - Переключает между светлой и темной темой оформления.
- **getCurrentThemeState()** [422-433] - Возвращает текущую тему ("dark" или "light").
- **restoreThemeState(theme)** [435-441] - Восстанавливает указанную тему оформления.
- **refreshCurrentView(forceUpdateCache)** [445-532] - Обновляет текущее представление закладок с учетом кэширования.
- **continueRefreshCurrentView(mainContent, currentFolderTitle, forceUpdateCache)** [534-664] - Продолжает обновление представления, загружая закладки и обновляя DOM.
- **showLoadingIndicator()** [666-679] - Показывает индикатор загрузки.
- **hideLoadingIndicator()** [681-689] - Скрывает индикатор загрузки.
- **showErrorMessage(message)** [691-693] - Отображает сообщение об ошибке.
- **initializeUI()** [695-761] - Инициализирует основной интерфейс, устанавливает обработчики событий и загружает корневые закладки.
- **showAddDialog(parentId)** [764-817] - Показывает диалог выбора типа элемента для добавления (закладка или папка).
- **showCreateFolderDialog(parentId)** [819-834] - Показывает диалог создания новой папки.
- **showCreateBookmarkDialog(parentId)** [836-852] - Показывает диалог создания новой закладки.
- **optimizeImage(file)** [854-896] - Оптимизирует загруженное изображение, уменьшая его размер.
- **handleIconUpload(file, folderId)** [898-919] - Обрабатывает загрузку пользовательской иконки для папки.
- **setupFileInput(customContent, folder)** [921-970] - Настраивает ввод файла для загрузки иконки папки.
- **showFolderEditDialog(folder)** [972-996] - Показывает диалог редактирования папки.
- **createFolderEditContent(folder, savedIconUrl)** [999-1037] - Создает содержимое диалога редактирования папки.
- **handleFolderEdit(folder, customContent, modal)** [1039-1091] - Обрабатывает сохранение изменений при редактировании папки.
- **initDragAndDrop()** [1093-1388] - Инициализирует функциональность drag-and-drop с использованием библиотеки Sortable.js.
- **processDragEnd(dragInfo)** [1390-1429] - Обрабатывает завершение операции перетаскивания.
- **refreshCurrentFolder()** [1431-1488] - Обновляет содержимое текущей папки.
- **continueRefreshCurrentFolder()** [1490-1504] - Продолжает обновление текущей папки.
- **moveItemToFolder(itemId, folderId)** [1506-1581] - Перемещает элемент в другую папку.
- **showDragIndicator(show)** [1583-1602] - Показывает или скрывает индикатор перетаскивания.
- **handleItemReordered(item, oldIndex, newIndex)** [1604-1656] - Обрабатывает изменение порядка элементов внутри контейнера.
- **handleItemMoved(item, fromContainer, toContainer, newIndex)** [1658-1691] - Обрабатывает перемещение элемента между папками.
- **showNotification(message, duration)** [1693-1722] - Показывает временное уведомление.
- **getTranslation(key)** [1724-1726] - Получает текст перевода по ключу.
- **createBookmarkElement(item, cachedIcons)** [1734-1821] - Создает DOM-элемент закладки или папки для отображения.
- **handleButtonClick(e)** [1823-1904] - Обрабатывает клики по кнопкам в элементе закладки.
- **setupBackButtonDropTarget()** [1906-2025] - Настраивает кнопку "Назад" как цель для перетаскивания.
- **handleDrop(evt)** [2027-2130] - Обрабатывает событие drop для перетаскиваемых элементов.
- **hideSettingsPage()** [2132-2168] - Скрывает страницу настроек и возвращает к основному интерфейсу.
- **hideTrashPage()** [2170-2203] - Скрывает страницу корзины и возвращает к основному интерфейсу.
- **clearHoverTimers()** [2205-2217] - Очищает все таймеры наведения.
- **updateFolderTitle(title)** [2219-2226] - Обновляет заголовок текущей папки.
- **toggleBackButton(show)** [2228-2233] - Показывает или скрывает кнопку "Назад".
- **showCreateNoteDialog** (строки 941-994) - Показывает диалог создания новой заметки в указанной папке.
- **showNoteEditDialog** (строки 1001-1049) - Показывает диалог редактирования существующей заметки.
- **handleBookmarkItemClick** (строки 1054-1084) - Обрабатывает клик по элементу, открывая заметки для редактирования.
- **createBookmarkElement** (строки 1089-1136) - Создает DOM-элемент для отображения закладки, папки или заметки.

## HTML файлы интерфейса

- **src/popup.html** - Основной интерфейс расширения с кнопками навигации, добавления закладок, перехода в корзину и настройки; содержит основной контейнер для отображения закладок.
- **src/settings.html** - Интерфейс страницы настроек с функциями импорта/экспорта закладок, переключением языка и информацией об авторе.
- **src/trash.html** - Интерфейс корзины с удаленными элементами и кнопкой для очистки корзины.

## CSS стили интерфейса

- **src/styles/dark-theme.css** - Определяет цветовую схему для темной темы, включая цвета фона, текста, границ и акцентов; переопределяет базовые элементы интерфейса для темного режима.
- **src/styles/light-theme.css** - Определяет цветовую схему для светлой темы с аналогичной структурой переменных; устанавливает светлые цвета для тех же элементов интерфейса.
- **src/styles/popup.css** - Содержит стили для функционала drag-and-drop, включая стили для перетаскиваемых элементов, индикаторов и подсветки зон для перетаскивания.
- **src/styles/settings.css** - Стили для страницы настроек, включая контейнеры, кнопки, переключатели языка, секции настроек и авторскую информацию.

### src/styles/main.css

1. **Базовые переменные и настройки** [1-70] - Определяет основные CSS-переменные (размеры, цвета, радиусы, анимации), устанавливает базовые стили для HTML и body, задает размеры окна расширения.

2. **Базовая структура интерфейса** [71-150] - Стили для основных контейнеров приложения, шапки (.header), позиционирование кнопок и элементов управления в шапке.

3. **Компоненты закладок и папок** [151-250] - Стили для элементов закладок (.bookmark-item), иконок (.bookmark-icon), заголовков (.bookmark-title), сетки элементов и пустых состояний.

4. **Переключатели и элементы управления** [251-350] - Стили для переключателя темы (.theme-switch), кнопок настроек, различия в отображении иконок в зависимости от текущей темы.

5. **Модальные окна и контекстное меню** [351-550] - Стили для модальных окон (.modal), контекстного меню (.context-menu), форм ввода и кнопок, всплывающих диалогов.

6. **Специфичные стили для тем** [551-750] - Переопределение стилей и цветов для светлой и темной темы, настройка скроллбара, кнопок и интерактивных элементов в зависимости от темы.

7. **Drag-and-Drop функциональность** [751-1388] - Стили для перетаскивания элементов, индикаторы для визуальной обратной связи, анимации для элементов во время перетаскивания, стили для библиотеки Sortable.js, индикаторы загрузки и уведомления.

## src/utils/logging.js

- **DEBUG_MODE** [7] - Флаг для включения/отключения логирования (true - включено, false - выключено).
- **log(message, data)** [15-23] - Выводит информационное сообщение в консоль, если включен режим отладки.
- **logError(message, error)** [31-39] - Выводит сообщение об ошибке в консоль независимо от режима отладки.
- **logWarn(message, data)** [47-55] - Выводит предупреждающее сообщение в консоль, если включен режим отладки.

## src/modules/NavigationModule.js

- **NavigationModule** [13-252] - Класс для управления навигацией по папкам закладок.
  - **constructor(container, updateUI)** [19-28] - Инициализирует модуль навигации с контейнером и функцией обновления UI.
  - **setupEventListeners()** [33-41] - Настраивает обработчики событий для навигации.
  - **handleContainerClick(e)** [47-59] - Обрабатывает клик на контейнере и определяет, был ли клик по папке.
  - **handleFolderClick(bookmarkElement)** [65-111] - Обрабатывает клик по папке и переходит в нее.
  - **handleBackButtonClick()** [116-176] - Обрабатывает клик по кнопке "Назад".
  - **updateFolderTitle(title)** [182-188] - Обновляет заголовок текущей папки.
  - **toggleBackButton(show)** [194-200] - Показывает или скрывает кнопку "Назад".
  - **showLoadingIndicator()** [205-216] - Показывает индикатор загрузки.
  - **hideLoadingIndicator()** [221-227] - Скрывает индикатор загрузки.
  - **saveNavigationState()** [232-234] - Сохраняет текущее состояние навигации в хранилище.
  - **setStack(stack)** [240-247] - Устанавливает стек навигации из сохраненного состояния. Исправлен в обновлении, чтобы использовать проверку `stack && stack.length > 0` вместо вызова несуществующего метода `isEmpty()`.
  - **getNavigation()** [252-254] - Возвращает объект навигации.
  - **getCurrentParentId()** [260-262] - Возвращает текущий ID родительской папки.

## src/modules/UIModule.js

- **UIModule** [12-156] - Класс для управления пользовательским интерфейсом.
  - **constructor(container, bookmarks)** [17-22] - Инициализирует модуль UI с контейнером и данными закладок.
  - **render(bookmarks, folderId, folderTitle)** [30-95] - Отображает закладки в зависимости от типа представления (корневое или вложенное).
  - **showEmptyMessage(isRoot)** [101-113] - Показывает сообщение о пустой папке.
  - **initializeInteractivity()** [119-122] - Инициализирует интерактивность для элементов.
  - **showLoadingIndicator()** [127-138] - Показывает индикатор загрузки.
  - **hideLoadingIndicator()** [143-149] - Скрывает индикатор загрузки.
  - **showErrorMessage(message)** [154-156] - Показывает сообщение об ошибке.
  - **showNotification(message, duration)** [162-180] - Показывает временное уведомление.
  - **showAddDialog(parentId, onItemAdded)** [186-189] - Показывает диалоговое окно добавления элемента.

## src/modules/DragDropModule.js

- **DragDropModule** [10-468] - Класс для управления перетаскиванием элементов.
  - **constructor(container, uiModule, navigationModule)** [17-37] - Инициализирует модуль с контейнером и зависимыми модулями.
  - **initDragAndDrop()** [42-53] - Инициализирует функциональность перетаскивания.
  - **handleDragStart(e)** [59-81] - Обрабатывает начало перетаскивания.
  - **handleDragEnd(e)** [87-121] - Обрабатывает завершение перетаскивания.
  - **handleDragOver(e)** [127-195] - Обрабатывает перемещение над целевым элементом.
  - **handleDragLeave(e)** [201-218] - Обрабатывает выход из целевого элемента.
  - **handleDrop(e)** [224-297] - Обрабатывает сброс перетаскиваемого элемента.
  - **setupBackButtonDropTarget()** [302-308] - Настраивает кнопку "Назад" как цель для перетаскивания.
  - **handleBackButtonDragOver(e)** [314-326] - Обрабатывает перемещение над кнопкой "Назад". Исправлен в обновлении, чтобы использовать свойство `isRoot` вместо метода `isEmpty()`.
  - **handleBackButtonDragLeave(e)** [331-333] - Обрабатывает выход из кнопки "Назад".
  - **handleBackButtonDrop(e)** [339-405] - Обрабатывает сброс на кнопку "Назад". Исправлен в обновлении, чтобы использовать свойство `isRoot` вместо метода `isEmpty()`.
  - **clearHoverEffects()** [410-424] - Очищает эффекты выделения и таймеры.

## src/modules/ContextMenuModule.js

- **ContextMenuModule** [11-243] - Класс для управления контекстным меню.
  - **constructor(uiModule, navigationModule)** [17-28] - Инициализирует модуль с зависимыми модулями.
  - **setupEventListeners()** [33-38] - Настраивает обработчики событий.
  - **handleContextMenu(e)** [44-75] - Обрабатывает событие открытия контекстного меню.
  - **\_handleMenuAction(action, element, id, isFolder, title, url)** [86-103] - Обрабатывает выбор пункта в контекстном меню.
  - **\_showBookmarkEditDialog(element, id, title, url)** [111-143] - Показывает диалог редактирования закладки.
  - **\_showFolderEditDialog(element, id, title)** [150-181] - Показывает диалог редактирования папки.
  - **\_handleDeleteAction(id, isFolder, title, url)** [189-232] - Обрабатывает действие удаления элемента.
  - **\_handleCopyAction(id, isFolder)** [239-262] - Обрабатывает действие копирования элемента.
  - **\_getFolderContentsRecursively(folderId)** [269-283] - Рекурсивно получает содержимое папки.
  - **\_showNoteEditDialog** (строки 135-180) - Показывает диалог редактирования заметки из контекстного меню.

## src/popup.js (обновленный)

- **DOMContentLoaded** [56-71] - Обновленный обработчик загрузки документа, теперь использует модульную структуру.
- **updateUI(bookmarks, folderId, folderTitle)** [132-142] - Обновляет интерфейс через модуль UIModule.
- **handleBackButtonClick()** [145-153] - Обработчик кнопки "Назад" через модуль NavigationModule.
- **showLoadingIndicator()** [156-170] - Показывает индикатор загрузки через модуль UIModule или запасной вариант.
- **hideLoadingIndicator()** [173-181] - Скрывает индикатор загрузки через модуль UIModule или запасной вариант.
- **showErrorMessage(message)** [184-192] - Показывает сообщение об ошибке через модуль UIModule или запасной вариант.
- **initializeUI()** [197-244] - Обновленная инициализация интерфейса с использованием модулей.
- **initEventListeners()** [249-277] - Инициализирует обработчики событий для глобальных событий.
- **refreshCurrentView(forceUpdateCache)** [282-331] - Обновляет текущее представление через модули.
- **handleThemeToggle(e)** [336-346] - Обработчик переключения темы.

## DragDropModule.js (обновлено)

### Улучшения стабильности перетаскивания [1-1351]

- **positionStability** [21-26] - Новый механизм стабилизации, который предотвращает "дрожание" при определении позиции элемента при перетаскивании.
- **handleDragOver** [288-306] - Улучшенный обработчик с ограничением частоты (throttling) для плавности и производительности.
- **\_processDragOver** [311-529] - Оптимизированный обработчик с расширенными зонами определения наведения и "мертвой зоной" для предотвращения колебаний.
- **handleDragLeave** [577-662] - Усовершенствованный обработчик с дополнительной проверкой фактического выхода из элемента и контролем над соседними элементами.
- **isPointInExtendedRect** [1328-1340] - Новая вспомогательная функция для проверки попадания точки в расширенные границы элемента.
- **clearHoverEffects** [1157-1187] - Улучшенная функция с дополнительным параметром для контроля над ghost-элементами.
- **handleMouseDown** [96-123] - Проверка левой кнопки мыши для предотвращения перетаскивания при правом клике.
- **handleRightClickDuringDrag** [129-143] - Новая функция для отмены перетаскивания при правом клике.
- **handleDragStart** [177-216] - Добавлен код для создания красивого превью при перетаскивании.

### Улучшения CSS в src/styles/fixes.css [99-396]

- Расширенные зоны обнаружения с использованием псевдоэлементов [113-150] - Создают увеличенную область для надежного определения наведения.
- GPU-ускорение с использованием `transform: translateZ(0)` [111-112] - Улучшает плавность анимаций и снижает нагрузку на CPU.
- Оптимизация перерисовки с `contain: layout style paint` [110] - Изолирует перерисовку элемента.
- Увеличенные буферные зоны между элементами [118-123] - Помогают более надежно определять наведение и предотвращают "прыжки" UI.
- Деактивация событий мыши для перетаскиваемого элемента [242] - Предотвращает нежелательные эффекты наведения.
- Плавные переходы c `cubic-bezier` [104-106] - Создают более естественные и приятные анимации.
- Улучшенная визуальная обратная связь для папок [288-312] - Делает более понятным взаимодействие с папками.

Эти улучшения решают проблемы, связанные с "дрожанием" элементов при перетаскивании, делают интерфейс более отзывчивым и плавным, добавляют возможность отмены перетаскивания правой кнопкой мыши и улучшают общий пользовательский опыт.

## src/styles/drag-and-drop.css

Новый выделенный файл стилей, содержащий все улучшения для функциональности drag-and-drop:

- **Основные стили drag-and-drop элементов** [12-28] - Базовые улучшения для плавности и производительности, включающие GPU-ускорение и оптимизацию перерисовки.
- **Расширенные зоны обнаружения наведения** [31-62] - Создание невидимых интерактивных зон вокруг элементов для улучшения обнаружения наведения.
- **Индикаторы и визуальные эффекты** [65-107] - Стили для визуальной обратной связи при перетаскивании над разными зонами элементов.
- **Анимации пульсации** [110-153] - Плавные анимации для состояний перетаскивания в разных темах.
- **Стили курсора** [156-183] - Улучшенные стили курсора в режиме перетаскивания.
- **Стили для активного перетаскивания** [186-194] - Эффекты и оптимизации для перетаскиваемого элемента.
- **Улучшенные стили для папок** [228-254] - Специальные эффекты и подсказки для папок при перетаскивании.
- **"Призрачные" элементы** [262-266] - Стили для невидимых элементов, сохраняющих хитбокс оригинального элемента.
- **Стили для кнопки "Назад"** [269-283] - Визуальные эффекты при перетаскивании над кнопкой возврата.
- **Фазы перетаскивания** [286-295] - Стили для разных фаз процесса перетаскивания.
- **Индикатор пустого контейнера** [298-309] - Стили для отображения индикатора при перетаскивании над пустой областью.

Этот файл заменяет все стили drag-and-drop, которые ранее находились в src/styles/fixes.css, обеспечивая лучшую организацию кода и изоляцию функциональности.

## Обновления и исправления для заметок (июль 2023)

- **Исправлены проблемы создания и восстановления заметок:**
  - Обновлен компонент `NoteModal.js` [7-186] для удаления поля содержимого при создании заметки, оставив его только в режиме редактирования
  - Добавлена дополнительная проверка типа элемента в функциях `createNote` [1057-1086] и `createStoredNote` [1097-1179] в `src/utils/bookmarks.js`
  - Обновлена функция `renderTrashItems` [82-170] в `src/trash.js` для корректного отображения заметок в корзине
  - Обновлены функции `restoreContents` [172-207] и `handleRestore` [210-282] в `src/trash.js` для корректного восстановления заметок из корзины
- **Улучшения интерфейса:**
  - При создании заметки теперь отображается только поле для заголовка
  - При редактировании существующей заметки доступны поля для заголовка и содержимого
  - Корректное отображение иконок для заметок в корзине и при восстановлении

## Обновления для отображения заметок в интерфейсе (июль 2023)

- **Исправлены проблемы отображения заметок в списке:**
  - Обновлен класс `MainInterface` в `src/components/MainInterface.js` [50-56, 70-76, 83-89, 95-101] - Добавлена поддержка отображения заметок с правильной иконкой и CSS-классом
  - Обновлен класс `NestedMenu` в `src/components/NestedMenu.js` [50-56, 70-76, 83-89, 95-101] - Добавлена поддержка отображения заметок с правильной иконкой и CSS-классом
  - Добавлен метод `getNoteIcon()` в оба класса для получения иконки заметки в зависимости от текущей темы
  - Добавлено сохранение дополнительных атрибутов для заметок (content, createdAt) при отображении

## src/utils/bookmarks.js (обновления для заметок)

- **createNote(parentId, title, content)** [707-739] - Создает новую заметку с указанным заголовком и содержимым в указанной папке.
- **createStoredNote(parentId, title, content, createdAt)** [742-798] - Вспомогательная функция для создания заметки в хранилище.
- **updateNote(id, data)** [801-837] - Обновляет существующую заметку, изменяя заголовок, содержимое и устанавливая временную метку редактирования.
- **generateBookmarksHTML(bookmarks, level)** [840-868] - Обновленная функция для генерации HTML-представления закладок с поддержкой заметок.
- **processBookmarkTreeWithNotes(bookmarks)** [871-915] - Рекурсивно обрабатывает дерево закладок при импорте с поддержкой заметок.

## Исправления функциональности заметок (июль 2023)

- **Исправлена проблема открытия заметок по клику:**
  - Обновлен класс `MainInterface` в `src/components/MainInterface.js` [89-110] - Добавлен прямой обработчик клика на элементы заметок
  - Обновлен класс `NestedMenu` в `src/components/NestedMenu.js` [89-110] - Добавлен прямой обработчик клика на элементы заметок
  - Функция `showNoteEditDialog` [1056-1109] в `src/popup.js` сделана глобально доступной через window для вызова из компонентов
  - Добавлено предотвращение всплытия события (e.stopPropagation) для предотвращения конфликтов с другими обработчиками

## Обновления и исправления (Исправление функционала кликов)

- **Исправлена работа кликов на закладки и заметки:**
  - В `src/components/MainInterface.js` (строки 103-117) добавлен прямой обработчик клика для закладок, открывающий URL в новой вкладке
  - В `src/components/NestedMenu.js` (строки 91-104) добавлен прямой обработчик клика для закладок, открывающий URL в новой вкладке
  - Функция `showNoteEditDialog` (строки 1053-1084) в `popup.js` теперь глобально доступна через объект window для вызова из обоих компонентов
  - Исправлен конфликт между прямыми обработчиками кликов компонентов и глобальным `handleBookmarkItemClick`

## src/components/MainInterface.js

- (строки 79-103) Добавлен прямой обработчик кликов для заметок, вызывающий showNoteEditDialog
- (строки 103-117) Добавлен прямой обработчик кликов для закладок, открывающий URL в новой вкладке
- Реализация метода render для отображения элементов bookmark-item

## src/components/NestedMenu.js

- (строки 78-102) Добавлен прямой обработчик кликов для заметок, вызывающий showNoteEditDialog
- (строки 91-104) Добавлен прямой обработчик кликов для закладок, открывающий URL в новой вкладке
- Реализация метода render для отображения элементов bookmark-item в режиме вложенного меню

## Обновления и исправления (Экспорт и импорт заметок)

- **Улучшено экспортирование и импортирование заметок:**
  - В функции `generateBookmarksHTML` [343-370] в `src/utils/bookmarks.js` реализован экспорт заметок в специальном HTML-формате `<EXT-NOTE>`, который браузер игнорирует при стандартном импорте
  - Обновлена функция `processBookmarkTreeWithNotes` [377-436] в `src/utils/bookmarks.js` для распознавания заметок в формате `<EXT-NOTE>` при импорте
  - Функция `parseBookmarksHTML` [192-225] в `src/settings.js` улучшена для корректного импорта заметок из HTML файла
  - Экспорт закладок в `src/settings.js` теперь использует универсальную функцию `exportBookmarksToHTML` из `src/utils/bookmarks.js`
  - Это позволяет сохранять заметки в HTML формате, который браузер игнорирует при стандартном импорте, но который наше расширение может полностью восстановить

## Обновления и исправления (Интерфейс заметок 2.0)

- **Улучшен интерфейс редактирования заметок:**

  - Переработан компонент `NoteModal` в `src/components/NoteModal.js` для более компактного и функционального интерфейса
  - Шапка модального окна уменьшена до 20px, содержит название заметки слева и метку "Редактор заметки" справа
  - Перенесена информация о дате создания в подвал слева от кнопок
  - Высота подвала уменьшена до 30px, кнопки сделаны компактнее для увеличения рабочей области
  - Область редактирования текста увеличена и выделена визуально с помощью бордера и фона
  - Добавлен стилизованный скроллбар в унифицированном стиле с основным интерфейсом
  - Обновлены стили в `src/styles/main.css` для поддержки нового компактного интерфейса заметок

- **Улучшен редактор заметок** в `src/components/NoteModal.js` [400-500] - Удалены опции Paragraph и Quote из панели инструментов редактора для упрощения интерфейса. Изменена иконка для нумерованного списка на "1." для большей интуитивности. Улучшена работа со ссылками: добавлена автоматическая подстановка префикса https:// при вводе адреса без протокола, предотвращая создание относительных ссылок.

- **Улучшена работа со ссылками в заметках** в `src/components/NoteModal.js` [510-580] - Реализован интеллектуальный режим работы со ссылками: в режиме просмотра ссылки кликабельны и открываются в новой вкладке, а в режиме редактирования ссылки не кликабельны для удобства редактирования. Добавлена возможность редактирования существующих ссылок по клику - при нажатии на ссылку в режиме редактирования открывается диалог для изменения URL или полного удаления ссылки при очистке поля.

- **Исправлена конфигурация в constants.js** - Добавлен идентификатор для кнопки корзины и исправлена структура кнопок добавления.

- **Улучшена функция `getFavicon(url)`** [254-313] в `src/utils/storage.js` - Добавлена мультистратегия получения фавиконов с использованием Chrome Favicon API, Google Favicon Service и прямого доступа к favicon.ico. Также улучшена обработка ошибок и валидация URL.

- **Улучшено отображение фавиконов для закладок** в `src/components/MainInterface.js` [89-101], `src/components/NestedMenu.js` [134-144] и `src/popup.js` (функция `createBookmarkElement` [1207-1244]) - Обновлены функции для отображения фавиконов закладок с корректной обработкой ошибок загрузки.

- **Обновлен manifest.json** - Добавлены хост-разрешения (`host_permissions`) для загрузки фавиконов с внешних сайтов и расширен Content Security Policy для поддержки внешних изображений.

- **Улучшена работа с фавиконами для закладок:**

  - Полностью переработана функция `getFavicon(url)` [254-313] в `src/utils/storage.js` - Реализована каскадная стратегия загрузки фавиконов с прямым доступом к favicon.ico сайта, через Google Favicon Service и Chrome Favicon API. Добавлена подробная диагностика ошибок.
  - Модифицированы компоненты `MainInterface` [89-123], `NestedMenu` [134-168] и функция `createBookmarkElement` [1207-1244] для активной загрузки фавиконов при отображении закладок, даже если они не были загружены при создании.
  - Добавлен механизм сохранения найденных фавиконов в хранилище для будущего использования через автоматические вызовы `updateBookmark`.
  - Добавлены улучшенные обработчики ошибок загрузки изображений с резервным отображением стандартной иконки.
  - Функция `getFavicon` сделана доступной глобально через `window.getFavicon` для упрощения доступа из компонентов.
  - Обновлен `manifest.json` с разрешениями для загрузки ресурсов с HTTP и HTTPS источников, а также доступа к `chrome://favicon`.

- **Добавлена функциональность управления фавиконами для закладок:**

  - В `src/utils/storage.js` добавлены функции:

    - `updateAllFavicons(progressCallback)` [373-423] - обходит все закладки и обновляет для них фавиконы с отображением процесса через callback
    - `setFaviconsEnabled(enabled)` [426-428] - включает/отключает отображение фавиконов
    - `getFaviconsEnabled()` [431-435] - возвращает текущую настройку отображения фавиконов
    - `clearAllFavicons()` [438-460] - удаляет все фавиконы из закладок

  - В `src/settings.js` добавлена функция:

    - `initFaviconToggle()` [121-164] - инициализирует переключатель фавиконов и обработчик его изменения

  - В `src/popup.js` добавлена функция:

    - `shouldShowFavicons()` [1271-1280] - проверяет, должны ли отображаться фавиконы согласно настройкам

  - Обновлены компоненты для поддержки условного отображения фавиконов:
    - `MainInterface.js` [135-167] - добавлена проверка настройки отображения фавиконов
    - `NestedMenu.js` [134-166] - добавлена проверка настройки отображения фавиконов

### Улучшение работы с фавиконами

- Функции в `src/utils/storage.js`:

  - `getFaviconsEnabled()` [471-483] - Получает состояние настройки отображения фавиконов из хранилища с улучшенной логикой проверки
  - `setFaviconsEnabled(enabled)` [456-468] - Сохраняет состояние настройки отображения фавиконов в хранилище
  - `updateAllFavicons(progressCallback)` [374-454] - Обновляет фавиконы для всех закладок
  - `clearAllFavicons()` [487-517] - Удаляет фавиконы из всех закладок

- Функции в `src/settings.js`:

  - `initFaviconToggle()` [216-278] - Инициализирует переключатель фавиконов и добавляет обработчик его изменения

- Функции в `src/popup.js`:
  - `shouldShowFavicons()` [1271-1280] - Проверяет состояние настройки отображения фавиконов

### Улучшения класса Storage

- Методы в `src/utils/storage.js`:

  - `Storage.get(key)` [36-44] - Улучшена обработка получения данных из хранилища
  - `Storage.set(key, value)` [46-65] - Добавлена улучшенная обработка ошибок и логирование

- **Улучшенная система получения фавиконов**

  - **getFavicon(url)** [288-391] в `src/utils/storage.js` - Полностью обновлен механизм получения фавиконов с поддержкой современных высококачественных источников: Apple Touch Icons (180x180), favicon.svg (вектор), PWA иконок (192x192), manifest.json, DuckDuckGo и Google. Добавлено кэширование фавиконов для оптимизации производительности.

  - **cleanupFaviconCache()** [14-41] в `src/utils/storage.js` - Новая функция для автоматической очистки кэша фавиконов, предотвращающая чрезмерное потребление памяти.

  - **getImageSize(url)** [603-611] в `src/utils/storage.js` - Вспомогательная функция для определения размеров изображения фавиконов. Используется для выбора иконки наилучшего качества.

  - **updateBookmarkFavicon(bookmarkId)** [539-599] в `src/utils/storage.js` - Улучшена функция обновления фавикона для отдельной закладки с проверкой качества полученного изображения и автоматической заменой на более качественную версию при необходимости.

  - **updateAllFavicons(progressCallback)** [395-503] в `src/utils/storage.js` - Улучшена функция массового обновления фавиконов с интеллектуальным выбором высококачественных версий.

- **Улучшенная система получения фавиконов**

  - **getFaviconFast(url)** [256-369] в `src/utils/storage.js` - Новая сверхбыстрая функция для получения высококачественных фавиконов. Использует прямой доступ к известным путям фавиконов, специальные URL для популярных сайтов и оптимизирована для максимальной скорости без проверок размера.

  - **specialCases** [25-61] в функции `getFaviconFast` - Встроенная база известных высококачественных фавиконов для более чем 20 популярных сайтов (YouTube, Facebook, Google, Twitter и др.), позволяющая получать HD-фавиконы без сетевых запросов.

  - **updateBookmarkFavicon(bookmarkId)** [539-599] в `src/utils/storage.js` - Обновлена функция обновления фавикона для отдельной закладки, теперь использует быструю функцию getFaviconFast.

  - **updateAllFavicons(progressCallback)** [395-503] в `src/utils/storage.js` - Обновлена функция массового обновления фавиконов для всех закладок с использованием новой быстрой функции getFaviconFast.

  - **createStoredBookmark(parentId, title, url)** [59-207] в `src/utils/storage.js` - Обновлена функция создания закладок, теперь использует getFaviconFast для получения высококачественных фавиконов при создании.

## src/settings.html

- **Структура страницы настроек** - Содержит разделы для управления закладками, отображением фавиконов, выбора языка и контактной информации.
- **Кнопки управления закладками** [41-64] - Импорт/экспорт закладок из браузера и файлов.
- **Переключатель фавиконов** [64-76] - Размещён внутри секции управления закладками, содержит стилизованный переключатель с индикатором загрузки.
- **Секция контактов** [79-85] - Информация об авторе расширения.
- **Переключатель языка** [87-97] - Выбор между русским и английским языками.

## src/styles/settings.css

- **Основные стили контейнеров и навигации** [1-32] - Стили для основных элементов страницы.
- **Стили для переключателя языка** [33-109] - Анимированный переключатель для выбора языка.
- **Стили секций** [110-125] - Оформление основных секций настроек.
- **Стили кнопок настроек** [126-168] - Оформление кнопок для импорта/экспорта закладок.
- **Стили для блока фавиконов** [169-192] - Оформление блока с переключателем фавиконов в стиле кнопок настроек.
- **Стили для переключателя фавиконов** [193-233] - Уменьшенный переключатель с анимацией.
- **Индикатор загрузки фавиконов** [234-278] - Анимированный индикатор прогресса.
- **Стили для контактной информации** [169-234] - Стилизация ссылок и информации об авторе.

## Обновления и исправления

- **Добавлена функциональность управления хранилищем** в `src/settings.js` [335-545] и `src/styles/settings.css` [406-478] - Добавлены функции для получения информации о хранилище и его очистки. Добавлена возможность просмотра информации о количестве закладок, размере данных, количестве иконок папок и элементов в корзине. Реализована функция полной очистки хранилища с подтверждением действия.

- **Улучшена функциональность отображения информации о хранилище** в `src/settings.js` [490-750, 780-845] - Информация теперь отображается в виде отдельных строк без разделителей и таблиц, с уменьшенным шрифтом для компактности. Добавлено отображение процентов использования для Chrome Storage и IndexedDB. Реализованы новые функции для оценки размера данных в IndexedDB (`getIndexedDBSize`, `estimateIconsSize`, `estimateTrashSize`), которые анализируют размер хранимых иконок папок и элементов корзины. Обновлены ключи локализации для поддержки нового формата отображения.

- **Улучшена анимация при наведении на кнопки управления хранилищем** в `src/styles/settings.css` [445-467] - Иконки кнопок теперь увеличиваются при наведении только на сами кнопки, а не на весь блок хранилища. Заменена анимация поворота на более понятное увеличение (scale), аналогично существующим кнопкам импорта/экспорта. Добавлены селекторы CSS для предотвращения нежелательных анимаций при наведении на родительские элементы.

- **Заменены иконки для кнопки очистки хранилища** в `src/settings.html` [92-95] - Вместо общих иконок trash.svg и trash_dark.svg использованы более специфичные иконки Trash_Empty_white.svg и Trash_Empty_black.svg для кнопки очистки хранилища, что сделало интерфейс более понятным и согласованным.

## src/modules/SearchModule.js

- **SearchModule** [1-275] - Класс для поиска закладок, папок и заметок.
  - **constructor(container, onResultSelect)** [12-22] - Инициализирует модуль поиска с контейнером и функцией обработки выбора результата.
  - **setupEventListeners()** [27-69] - Настраивает обработчики событий для элементов поиска.
  - **toggleSearch()** [74-80] - Переключает состояние поиска (открыт/закрыт).
  - **openSearch()** [85-89] - Открывает поиск и устанавливает фокус на поле ввода.
  - **closeSearch()** [94-98] - Закрывает поиск и очищает результаты.
  - **clearSearch()** [103-108] - Очищает поисковый запрос и результаты.
  - **handleSearchInput(query)** [113-129] - Обрабатывает ввод в поле поиска и выполняет поиск.
  - **searchBookmarks(bookmarks, query)** [137-193] - Выполняет поиск по закладкам, папкам и заметкам.
  - **stripHtmlTags(html)** [201-205] - Удаляет HTML теги из текста для поиска в содержимом заметок.
  - **displayResults(results)** [213-265] - Отображает результаты поиска.
  - **selectResult(result)** [273-276] - Обрабатывает выбор результата поиска.
  - **toggleVisibility(isMainView)** [284-290] - Показывает/скрывает контейнер поиска в зависимости от типа представления.

## Обновления и исправления

- **Исправлено отображение иконки поиска в режиме вложенного меню** - В `src/modules/SearchModule.js`, `src/popup.js` и `src/modules/NavigationModule.js`:

  - Обновлен метод `toggleVisibility(isMainView)` [306-316] в SearchModule.js для скрытия не только контейнера поиска, но и кнопки поиска во вложенных меню
  - Сделан модуль поиска глобально доступным через `window.searchModule` в popup.js для доступа из других модулей
  - Добавлена проверка и обновление видимости поиска в методе `handleFolderClick` NavigationModule.js
  - Добавлено обновление видимости поиска при возврате в корневую папку в методе `handleBackButtonClick` NavigationModule.js

- **Добавлено всплывающее окно с путем элемента в результатах поиска** - В `src/modules/SearchModule.js` [297-337] и `src/styles/main.css` [2035-2061]:
  - В результатах поиска теперь показывается только заголовок и URL для закладок
  - Добавлено всплывающее окно, которое появляется через 1.5 секунды после наведения на элемент результата поиска
  - Всплывающее окно показывает полный путь к элементу в формате "папка1 > папка2 > ..."
  - Реализован учет темы оформления для всплывающего окна с соответствующими стилями для темной и светлой темы
  - Добавлены методы `showPathTooltip` и `hideTooltip` для управления отображением всплывающего окна

## Обновления и исправления (Поисковый модуль)

- **Улучшена обработка URL в SearchModule.js** [329-345] - Добавлена валидация URL перед созданием объекта URL для получения favicon. Реализована проверка с использованием регулярного выражения и корректная обработка невалидных URL для предотвращения ошибки "Invalid URL" при поиске коротких строк или некорректных данных.

- **Оптимизирована асинхронная загрузка настроек в SearchModule.js** [250-275] - Улучшен метод displayResults для асинхронной загрузки настройки фавиконов без блокировки основного потока отображения. Реализован подход с использованием Promise для предотвращения задержек при поиске, когда включена опция отображения фавиконов.

- **Улучшена производительность функции getFaviconsEnabled в storage.js** [785-795] - Оптимизирована функция получения настройки отображения фавиконов: удалено избыточное логирование, упрощена логика получения значения настройки для ускорения работы. Эти изменения обеспечивают более быструю работу поиска при любых настройках.

## Обновления и исправления (Оптимизация интерфейса)

- **Улучшенный компактный интерфейс загрузки иконок папок в src/styles/main.css** [652-778] - Оптимизирован блок загрузки иконок для папок:
  - Уменьшены вертикальные отступы для .icon-upload-group (margin-top: 20px → 12px, padding-top: 15px → 10px)
  - Уменьшен размер шрифта для меток и кнопок (font-size: 14px → 13px)
  - Изменены размеры кнопки загрузки (padding: 6px 12px → 4px 10px)
  - Оптимизирована область предпросмотра (размер: 128px → 96px, граница: 2px → 1px)
  - Уменьшены размеры .folder-icon-preview (48px → 40px)
  - Уменьшена тень при наведении на кнопку (box-shadow: 0 2px 5px → 0 1px 3px)
  - Сокращены отступы между элементами (gap: 10px → 6px, margin-top: 12px → 8px)

## Обновления и исправления (Фавиконы)

- **Исправлен механизм отображения фавиконов для закладок в getFaviconFast(url)** [932-1092] в `src/utils/storage.js` - Улучшена логика отображения запасной иконки, если фавикон не может быть получен. Вместо использования DuckDuckGo URL теперь используется Google favicon API. Если происходит ошибка при загрузке фавикона, используется наша собственная SVG иконка (/assets/icons/link.svg). Изменение предотвращает отображение отсутствующих фавиконов для некоторых URL.

## Обновления и исправления (Поисковый модуль)

- **Исправлен баг с отображением содержимого заметок при открытии через поиск** в `src/modules/SearchModule.js` [177-220] и `src/popup.js` [235-244]:
  - В функции `searchBookmarks` добавлено включение полей `content` и `createdAt` в результаты поиска для заметок
  - В функции `handleSearchResult` добавлено логирование при открытии заметки из поиска для упрощения отладки
  - Эти изменения обеспечивают полноценную передачу контента заметки в модальное окно при открытии через поиск

## Обновления и исправления (Заметки)

- **Исправлен баг с невозможностью перемещения заметки после просмотра/закрытия** в `src/components/NoteModal.js` [972-987]:

  - Добавлен сброс глобальных флагов перетаскивания (`window.isDragging` и `window.preventRefreshAfterDrop`) в методе `close()`
  - Добавлено удаление классов перетаскивания с DOM-элементов при закрытии модального окна заметки
  - Исправление решает проблему, когда заметку нельзя было перемещать после просмотра или закрытия диалога без сохранения изменений

- **Приоритизирована возможность перемещения заметок над сохранением незавершенных перемещений** в `src/components/NoteModal.js` [914-945], `src/components/Modal.js` [386-426]:
  - Реализован полный сброс всех состояний перетаскивания при закрытии модального окна в методе `resetDragState()`
  - Добавлено принудительное обновление интерфейса после закрытия окна заметки
  - Произведена полная очистка всех классов и атрибутов перетаскивания в DOM после закрытия заметки
  - Полностью сбрасываются флаги `window.isDragging` и `window.preventRefreshAfterDrop`
  - Хотя это может отменять незавершенные операции перетаскивания, это гарантирует стабильную работу функции перемещения заметок
  - Предпочтение отдано работоспособности перемещения заметок

# Документация функций расширения Extension Bookmarks GH

## Новые функции - Модальное окно добавления закладок из контекстного меню

### `src/background.js`

- **createContextMenu()** [28-56] - Создает пункт контекстного меню "Добавить в менеджер закладок GH".
- **extractFolders(items)** [435-460] - Извлекает только папки из дерева закладок для отображения в модальном окне.
- **showAddBookmarkModal(tabId, url, title)** [390-420] - Отправляет команду в content script для отображения модального окна.
- **addBookmarkToFolder(items, folderId, bookmark)** [462-489] - Добавляет закладку в указанную папку.
- **chrome.contextMenus.onClicked** [333-387] - Обработчик клика по пункту контекстного меню.

### `src/content.js`

- **showAddBookmarkModal(url, title)** [75-115] - Отображает модальное окно добавления закладки на веб-странице.
- **addModalStyles()** [120-317] - Добавляет CSS стили для модального окна.
- **setupModalEventListeners(modal, url, title)** [331-389] - Настраивает обработчики событий для модального окна.
- **loadFolderStructure(modal)** [397-420] - Загружает структуру папок из хранилища.
- **renderFolderStructure(folders, container)** [428-469] - Отображает структуру папок в модальном окне.
- **renderFolder(folder)** [477-505] - Рендерит отдельную папку для отображения в структуре.
- **setupFolderEventListeners(container)** [513-540] - Настраивает обработчики событий для вложенных папок.

## Функции расширения

### `manifest.json`

- **permissions** - Разрешения для расширения, включая доступ к хранилищу, закладкам, загрузкам и контекстному меню.
- **content_scripts** - Скрипты для внедрения в веб-страницы, используются для модального окна добавления закладок.

### `src/background.js`

- **chrome.runtime.onInstalled** [1-41] - Инициализирует расширение при установке, создает базовую структуру папок.
- **extractFaviconsFromHTML(html, baseUrl)** [150-213] - Извлекает фавиконы из HTML-кода страницы.
- **checkFaviconPaths(baseUrl, paths)** [216-244] - Проверяет доступность конкретных путей фавиконов.

### `src/popup.js`

Основной файл для управления интерфейсом расширения в popup-окне.

### `src/utils/bookmarks.js`

Содержит утилиты для работы с закладками и папками.

## Взаимодействие между компонентами

1. При клике правой кнопкой мыши по странице или ссылке появляется пункт меню "Добавить в менеджер закладок GH".
2. При выборе этого пункта background.js отправляет сообщение в content.js для отображения модального окна.
3. В модальном окне пользователь может указать название и URL закладки, а также выбрать папку для сохранения.
4. При сохранении закладки content.js отправляет сообщение в background.js, который добавляет закладку в хранилище.
5. Если content script не может быть загружен на странице, открывается обычное окно расширения.

## Обновления и исправления (Модальное окно добавления закладок)

- **Улучшен механизм загрузки content script для показа модального окна закладок** в `src/background.js`:

  - **showAddBookmarkModal(tabId, url, title)** [390-420] - Обновлена функция, теперь сначала проверяет, загружен ли content script, и если нет, программно внедряет его перед отправкой команды на отображение модального окна.
  - **sendShowModalMessage(tabId, url, title)** [422-455] - Добавлена новая вспомогательная функция для отправки сообщения на отображение модального окна после загрузки content script.
  - **extractFolders(items)** [509-534] - Улучшена функция для извлечения папок из общего списка закладок. Добавлены проверки на существование данных и дополнительные логи для отладки.

- **Добавлена поддержка проверки загрузки content script** в `src/content.js`:

  - **Обработчик сообщения "ping"** [12-28] - Добавлен для проверки загруженности content script.
  - **loadFolderStructure(modal)** [508-540] - Улучшена загрузка структуры папок, добавлены дополнительные проверки и логирование.
  - **renderFolderStructure(folders, container)** [542-582] - Улучшено отображение структуры папок в модальном окне с поддержкой корневой папки и пустого состояния.
  - **renderFolder(folder)** [584-620] - Отвечает за рендеринг отдельной папки в дереве.
  - **setupFolderEventListeners(container)** [622-650] - Добавлена новая функция для настройки интерактивности дерева папок (раскрытие/скрытие вложенных папок).
  - **addModalStyles()** [652-867] - Улучшены стили для модального окна и структуры папок.

- **Расширены разрешения расширения** в `manifest.json`:
  - Добавлено разрешение "scripting" [7-13] для программной загрузки content script в активную вкладку.

Эти изменения решают проблему с открытием полноценного окна расширения вместо модального окна при добавлении закладки через контекстное меню. Теперь система сначала проверяет, загружен ли content script, и если нет, программно загружает его перед отправкой команды на отображение модального окна. Это обеспечивает корректную работу функционала добавления закладок через контекстное меню браузера.

## Обновления и исправления (Модальное окно добавления закладок - Июль 2023)

- **Исправлены проблемы в модальном окне добавления закладок** в `src/content.js` и `src/background.js`:
  - **showAddBookmarkModal(url, title)** [75-115] - Добавлена поддержка темной темы для модального окна путем проверки текущей темы в chrome.storage.
  - **addModalStyles()** [120-317] - Добавлены стили для темной темы модального окна с использованием класса gh-bookmark-dark-theme.
  - **renderFolderStructure(folders, container)** [428-469] - Улучшена обработка пустых или некорректных массивов папок с добавлением безопасного приведения типов.
  - **extractFolders(items)** [435-460] - Исправлена логика для корректного извлечения всех вложенных папок на всех уровнях вложенности.
  - **Обработчик "saveBookmark"** [100-180] - Добавлена проверка на существование свойства children в корневом объекте закладок для предотвращения ошибки при сохранении.

## Обновления и исправления (Модальное окно добавления закладок - Июль 2023 - улучшения v2)

- **Улучшено отображение папок в модальном окне добавления закладок** в `src/background.js` и `src/content.js`:
  - **fixBookmarksStructure()** [612-710] - Новая функция для проверки и исправления структуры закладок в хранилище, чтобы гарантировать корректное отображение папок.
  - **Переработан метод получения структуры папок** [112-196] - Улучшен алгоритм извлечения папок со всех уровней вложенности для корректного отображения в модальном окне.
  - **Добавлена кнопка обновления списка папок** [75-85] - В модальное окно добавлена кнопка для принудительного обновления списка папок, которая инициирует проверку и исправление структуры закладок.
  - **Улучшено логирование** - Добавлено подробное логирование на всех этапах получения и отображения структуры папок для облегчения диагностики проблем.
  - **Автоматическая проверка структуры** [35-45] - Добавлено автоматическое исправление структуры закладок при старте и установке расширения.

Эти улучшения решают проблему с отображением папок в модальном окне: теперь корректно отображаются все папки из структуры закладок, а если папки все еще не видны, можно использовать кнопку обновления для исправления структуры хранилища.

## Описание функций

### src/content.js

#### Общие функции

// ... existing code ...

#### Модальное окно для добавления закладок

- **showBookmarkModal** (строки 100-200) - Создает и отображает модальное окно для добавления закладок в расширение.
- **setupModalEventListeners** (строки 420-700) - Настраивает обработчики событий для модального окна.
- **loadFolderStructure** (строки 790-850) - Загружает структуру папок для отображения в модальном окне. Использует requestFullBookmarksStructure для получения данных.
- **requestFullBookmarksStructure** (строки 860-940) - Запрашивает полную структуру закладок из хранилища или background script с дополнительной обработкой ошибок.
- **extractFoldersFromStructure** (строки 950-1000) - Извлекает структуру папок из полной структуры закладок с подробным логированием.
- **renderFolderStructure** (строки 1080-1150) - Отображает структуру папок в модальном окне, вызывает renderSimplifiedFolderStructure.
- **renderSimplifiedFolderStructure** (строки 1010-1070) - Упрощенное отображение структуры папок с использованием плоского списка вместо вложенного для повышения надежности.
- **setupFolderEventListeners** (строки 1160-1200) - Настраивает обработчики событий для элементов папок.
- **showFolderError** (строки 1210-1220) - Отображает сообщение об ошибке в контейнере папок.
- **saveBookmark** (строки 1230-1270) - Сохраняет закладку в выбранную папку.

### src/background.js

#### Обработчики сообщений

- **getFullBookmarksStructure** (строки 400-450) - Обработчик сообщения для получения полной структуры закладок с валидацией и исправлением структуры при необходимости.
- **fixBookmarksStructure** (строки 510-570) - Обработчик сообщения для полного исправления структуры закладок, пытается сохранить существующие данные, но при необходимости создает новую структуру.
- **createFolder** (строки 580-650) - Обработчик сообщения для создания новой папки в указанной родительской папке.

#### Вспомогательные функции

- **generateUniqueId** (строки 1500-1510) - Генерирует уникальный идентификатор для элементов закладок.
- **createDefaultFolder** (строки 1520-1530) - Создает объект папки с базовыми параметрами и уникальным ID.

## Обновления и исправления (Модальное окно добавления закладок - Август 2023)

- **Упрощена реализация модального окна добавления закладок** в `src/content.js` и `src/background.js`:

  - **showAddBookmarkModal(url, title)** [75-115] - Упрощено модальное окно добавления закладок, заменено дерево папок на выпадающий список.
  - **loadFolderList(modal)** [130-165] - Новая функция для загрузки списка папок в выпадающий список с отображением иерархии через отступы.
  - **getAllFolders(bookmarks)** [170-205] - Функция для получения плоского списка всех папок с указанием уровня вложенности.
  - **saveBookmark(folderId, bookmark, modal)** [390-420] - Функция для сохранения закладки в выбранную папку через background script.
  - **setupModalEventListeners(modal, url, title)** [290-380] - Упрощены обработчики событий для модального окна, удалены сложные механизмы.
  - **addModalStyles()** [210-290] - Обновлены стили для модального окна с учетом нового дизайна с выпадающим списком.

- **Улучшена обработка сохранения закладок в background.js**:
  - **Обработчик saveBookmark** [1800-1860] - Обновлен обработчик сообщения для сохранения закладки в выбранную папку.
  - **addBookmarkToFolder(items, folderId, bookmark)** [1870-1900] - Упрощена вспомогательная функция для добавления закладки в указанную папку.

Эти изменения делают модальное окно добавления закладок более простым и надежным:

- Плоский выпадающий список вместо сложного дерева папок
- Прямое сохранение в выбранную папку без лишних операций
- Удаление ненужных механизмов исправления структуры данных и отладки

# Функции для работы с закладками в src/background.js

## Управление структурой закладок

- **forceInitializeBookmarks()** (строки 1745-1785) - Принудительно инициализирует структуру закладок, создавая новую базовую структуру с папками "Избранное", "Работа" и "Личное".

- **initializeDefaultBookmarks()** (строки 1830-1835) - Обертка над forceInitializeBookmarks для обратной совместимости.

- **fixBookmarksStructure()** (строки 1790-1825) - Проверяет и исправляет существующую структуру закладок, исправляя ошибки и добавляя отсутствующие поля.

- **addBookmarkToFolder(items, folderId, bookmark)** (строки 1580-1620) - Добавляет закладку в указанную папку, рекурсивно ищет папку по ID.

## Диагностические функции

- **getBookmarksDebug** (обработчик, строки 590-630) - Проверяет и возвращает структуру закладок для отладки, а также может принудительно пересоздать структуру.

## Функции модального окна

- **showAddBookmarkModal(tabId, url, title)** (строки 420-450) - Отправляет команду в content script для отображения модального окна добавления закладки.

- **sendShowModalMessage(tabId, url, title)** (строки 460-490) - Отправляет сообщение в content script для отображения модального окна.

## Модальное окно добавления закладок из контекстного меню

- **createContextMenu()** [36-48] в `src/background.js` - Создает пункт контекстного меню "Добавить в менеджер закладок GH" для страниц и ссылок.

- **chrome.contextMenus.onClicked()** [50-70] в `src/background.js` - Обработчик события клика по пункту контекстного меню, вызывает функцию showAddBookmarkModal для отображения модального окна.

- **showAddBookmarkModal(tabId, url, title)** [128-160] в `src/background.js` - Асинхронная функция, проверяет валидность вкладки и инжектирует контентный скрипт для отображения модального окна.

- **injectContentScriptAndShowModal(tabId, url, title)** [162-192] в `src/background.js` - Проверяет, был ли уже инжектирован скрипт модального окна, и инжектирует его при необходимости, затем отправляет сообщение для отображения модального окна.

- **sendShowModalMessage(tabId, url, title)** [194-228] в `src/background.js` - Отправляет сообщение в контентный скрипт для отображения модального окна с заданными параметрами.

- **getFolderStructure** [440-632] в `src/background.js` - Обработчик сообщения для получения структуры папок в модальном окне. Получает список всех папок из хранилища, включая вложенные папки, для отображения в выпадающем списке при сохранении закладки.

- **saveBookmark** [743-773] в `src/background.js` - Обработчик сообщения для сохранения закладки в структуру расширения. Получает данные закладки и ID родительской папки, затем сохраняет закладку в хранилище.

- **saveBookmarkToStructure(bookmarks, parentId, bookmark, sendResponse)** [1151-1200] в `src/background.js` - Функция для сохранения закладки в указанную папку структуры закладок. Принимает текущую структуру, ID родительской папки, объект закладки и функцию обратного вызова.

- **showSimpleBookmarkModal(url, title)** [78-271] в `src/content.js` - Создает и отображает модальное окно для добавления закладки со всеми необходимыми полями (название, URL, выбор папки) и кнопками.

- **loadFolderStructure(modal)** [419-506] в `src/content.js` - Загружает структуру папок из background.js и заполняет выпадающий список папок в модальном окне.

- **processFoldersResponse(folders, folderSelect)** [509-559] в `src/content.js` - Обрабатывает массив папок и заполняет выпадающий список с правильными отступами для визуального отображения вложенности.

- **processFolderStructure(bookmarks, folderSelect)** [562-598] в `src/content.js` - Обрабатывает полную структуру закладок и заполняет выпадающий список папок.

- **getAllFolders(bookmarks, indent, result)** [601-634] в `src/content.js` - Рекурсивно извлекает все папки из структуры закладок в плоский список с информацией об отступах для визуальной вложенности.

- **extractNestedFolders(items)** [948-977] в `src/background.js` - Рекурсивно извлекает вложенные папки из массива элементов, сохраняя структуру вложенности.

## Модальное окно добавления закладок из контекстного меню (упрощенная версия)

- **getFolderStructure** [440-500] в `src/background.js` - Упрощенный обработчик сообщения для получения структуры папок в модальном окне. Просто возвращает существующие папки из хранилища без попыток исправить структуру.

- **extractFolders(items)** [502-524] в `src/background.js` - Вспомогательная функция для рекурсивного извлечения папок из структуры. Используется в getFolderStructure.

- **saveBookmark** [746-800] в `src/background.js` - Упрощенный обработчик сообщения для сохранения закладки. Получает текущую структуру из хранилища и добавляет закладку в указанную папку или в корень, если выбрана корневая папка.

- **loadFolderStructure(modal)** [419-503] в `src/content.js` - Упрощенная функция загрузки структуры папок. Делает запрос к background.js и отображает полученные папки в выпадающем списке.

## Обновления и исправления

- **Улучшено позиционирование вложенных подменю закладок** в `src/content.js` [1230-1250] - Исправлено выравнивание элементов в выпадающих подменю для обеспечения их точного вертикального позиционирования. Теперь элементы подменю выравниваются по вертикальному центру родительского элемента с учетом паддингов, что устраняет проблему постепенного смещения вниз при открытии вложенных подменю.

## Обновления и исправления

- **Улучшена обработка фавиконов** в `src/utils/storage.js` [975-1093] - Исправлена синтаксическая ошибка в объекте specialCases, улучшена обработка ошибок загрузки фавиконов, изменен порядок источников фавиконов для более надежного отображения.

- **Улучшена обработка ошибок в компонентах** в `src/components/MainInterface.js` [155-215] и `src/components/NestedMenu.js` [155-215] - Добавлена дополнительная обработка ошибок при загрузке фавиконов, реализован запасной вариант при недоступности функций получения настроек фавиконов, улучшена логика обновления фавиконов для закладок.

## Обновления и исправления

- **Исправлены ошибки с фавиконами** - Для устранения ошибок в консоли и повышения надежности работы с фавиконами:

  - В `manifest.json` [15, 41] удалено недопустимое разрешение `chrome://favicon/*` из host_permissions и content_security_policy
  - В `src/utils/storage.js` [975-1093] упрощена функция getFaviconFast для использования стабильного источника фавиконов
  - В `src/components/MainInterface.js` [155-190] и `src/components/NestedMenu.js` [155-190] добавлена предварительная проверка корректности URL фавиконов и автоматическое удаление некорректных фавиконов из закладок

- **Улучшена обработка фавиконов** в `src/utils/storage.js` [975-1093] - Исправлена синтаксическая ошибка в объекте specialCases, улучшена обработка ошибок загрузки фавиконов, изменен порядок источников фавиконов для более надежного отображения.

- **Улучшена обработка ошибок в компонентах** в `src/components/MainInterface.js` [155-215] и `src/components/NestedMenu.js` [155-215] - Добавлена дополнительная обработка ошибок при загрузке фавиконов, реализован запасной вариант при недоступности функций получения настроек фавиконов, улучшена логика обновления фавиконов для закладок.

## Обновления и исправления

- **Возврат к исходной быстрой функции getFaviconFast** в `src/utils/storage.js` [975-1093] - Возвращена быстрая и эффективная версия функции получения фавиконов. Для работы с субдоменами использует сервис DuckDuckGo, который лучше обрабатывает нестандартные случаи. Исправлена синтаксическая ошибка в объекте specialCases.

- **Улучшена работа с фавиконами для субдоменов** в `src/utils/storage.js` [975-1100] - Реализована специальная логика обработки для платформ-конструкторов сайтов (GetCourse, Tilda и др.), которая определяет субдомены и находит для них корректные фавиконы. Добавлен параллельный асинхронный запрос нескольких источников фавиконов для повышения вероятности получения корректного изображения.

- **Исправлены ошибки с фавиконами** - Для устранения ошибок в консоли и повышения надежности работы с фавиконами:

  - В `manifest.json` [15, 41] удалено недопустимое разрешение `chrome://favicon/*` из host_permissions и content_security_policy
  - В `src/utils/storage.js` [975-1093] упрощена функция getFaviconFast для использования стабильного источника фавиконов
  - В `src/components/MainInterface.js` [155-190] и `src/components/NestedMenu.js` [155-190] добавлена предварительная проверка корректности URL фавиконов и автоматическое удаление некорректных фавиконов из закладок

- **Улучшена обработка фавиконов** в `src/utils/storage.js` [975-1093] - Исправлена синтаксическая ошибка в объекте specialCases, улучшена обработка ошибок загрузки фавиконов, изменен порядок источников фавиконов для более надежного отображения.

- **Улучшена обработка ошибок в компонентах** в `src/components/MainInterface.js` [155-215] и `src/components/NestedMenu.js` [155-215] - Добавлена дополнительная обработка ошибок при загрузке фавиконов, реализован запасной вариант при недоступности функций получения настроек фавиконов, улучшена логика обновления фавиконов для закладок.

## Обновления и исправления

- **Расширена поддержка сервисов Google** в `src/utils/storage.js` [983-1000] - Добавлена специальная обработка для получения правильных фавиконов Google Drive, YouTube-каналов и Google Docs. Теперь сервисы Google отображаются с правильными иконками.

- **Возврат к исходной быстрой функции getFaviconFast** в `src/utils/storage.js` [975-1093] - Возвращена быстрая и эффективная версия функции получения фавиконов. Для работы с субдоменами использует сервис DuckDuckGo, который лучше обрабатывает нестандартные случаи. Исправлена синтаксическая ошибка в объекте specialCases.

- **Улучшена работа с фавиконами для субдоменов** в `src/utils/storage.js` [975-1100] - Реализована специальная логика обработки для платформ-конструкторов сайтов (GetCourse, Tilda и др.), которая определяет субдомены и находит для них корректные фавиконы. Добавлен параллельный асинхронный запрос нескольких источников фавиконов для повышения вероятности получения корректного изображения.

## Обновления и исправления

- **Улучшена обработка фавиконов для YouTube и Google Docs** в `src/utils/storage.js` [931-1092] (функция `getFaviconFast`) - Расширена поддержка URL-адресов YouTube, включая плейлисты (URL с параметром `list=` или путем `/playlist`), а также главную страницу YouTube. Для Google Docs добавлена обработка документов по пути `/document` без идентификатора, а также улучшена обработка базовых URL сервиса. Эти изменения обеспечивают корректное отображение фавиконов для всех ссылок на YouTube и Google Docs, включая плейлисты и текстовые документы.

- **Обновлены URL-адреса фавиконов для YouTube и Google Docs** в `src/utils/storage.js` [931-1092] (функция `getFaviconFast`) - Заменены устаревшие ссылки на фавиконы YouTube и Google Docs на актуальные и стабильные. Для YouTube использован постоянный URL на CDN Google (`https://www.gstatic.com/youtube/img/branding/favicon/favicon_144x144.png`). Для Google Docs обновлены все пути к иконкам сервисов, в том числе исправлен путь к иконке текстовых документов на `https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico` и добавлена поддержка URL-адресов с параметром `/spreadsheets/u/` для таблиц. Эти изменения обеспечивают корректное отображение фавиконов для всех сервисов Google и YouTube.
